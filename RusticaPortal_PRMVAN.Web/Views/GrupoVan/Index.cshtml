@{
    ViewData["Title"] = "Grupos VAN";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid" id="grupos-van-app">
    <div class="d-flex align-items-center justify-content-between bg-light border rounded p-3 sticky-top" style="top: 70px; z-index: 1030;">
        <div>
            <div class="fw-bold">Tienda seleccionada: <span id="headerTienda">-</span></div>
            <div>Grupo VAN seleccionado: <span id="headerGrupo">-</span></div>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div class="d-flex align-items-center gap-1">
                <span class="text-secondary">Pendientes</span>
                <span class="badge bg-warning text-dark" id="pendingBadge">0</span>
            </div>
            <button id="btnActualizarTodo" class="btn btn-primary" disabled>Actualizar todo</button>
        </div>
    </div>

    <div id="alertas" class="mt-3"></div>

    <div class="row mt-3">
        <div class="col-md-3 mb-3">
            <div class="card h-100 shadow-sm">
                <div class="card-header">Tiendas</div>
                <div class="card-body d-flex flex-column">
                    <input type="text" id="buscarTienda" class="form-control mb-2" placeholder="Buscar tienda" />
                    <div id="tiendasLista" class="list-group flex-grow-1 overflow-auto" style="max-height: 70vh;"></div>
                </div>
            </div>
        </div>

        <div class="col-md-5 mb-3">
            <div class="card h-100 shadow-sm">
                <div class="card-header">Grupo VAN por tienda</div>
                <div class="card-body d-flex flex-column">
                    <div class="row g-2 mb-2">
                        <div class="col-10">
                            <select id="selectGrupoMaestro" class="form-select"></select>
                        </div>
                        <div class="col-2 d-grid">
                            <button id="btnAgregarGrupo" class="btn btn-success">+</button>
                        </div>
                    </div>
                    <div class="table-responsive position-relative flex-grow-1" style="max-height: 65vh;">
                        <table class="table table-sm table-bordered align-middle" id="tablaGrupos">
                            <thead class="table-light">
                                <tr>
                                    <th class="sticky-col">Grupo VAN</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card h-100 shadow-sm">
                <div class="card-header">Asignación de artículos VAN</div>
                <div class="card-body d-flex flex-column">
                    <div class="row g-2 mb-2">
                        <div class="col-10">
                            <input id="inputArticulo" class="form-control" placeholder="Código o nombre" list="listaArticulos" autocomplete="off" />
                            <datalist id="listaArticulos"></datalist>
                            <small class="text-muted" id="articuloSeleccionado"></small>
                        </div>
                        <div class="col-2 d-grid">
                            <button id="btnAgregarArticulo" class="btn btn-success">+</button>
                        </div>
                    </div>
                    <div class="table-responsive position-relative flex-grow-1" style="max-height: 65vh;">
                        <table class="table table-sm table-bordered align-middle" id="tablaArticulos">
                            <thead class="table-light">
                                <tr>
                                    <th class="sticky-col">Código</th>
                                    <th>Descripción</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalCambios" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cambios pendientes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Hay cambios pendientes sin guardar. ¿Deseas descartarlos?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Volver</button>
                    <button type="button" class="btn btn-danger" id="btnDescartar">Descartar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .sticky-col {
        position: sticky;
        left: 0;
        background: #fff;
        z-index: 2;
    }
    .fila-pendiente {
        background-color: #fff3cd !important;
    }
</style>

      <script>
          const state = {
              tiendas: [],
              gruposMaestro: [],
              gruposTienda: [],
              articulosGrupo: [],
              articulosMaestro: [],
              articuloSeleccionado: null,
              tiendaActual: null,
              grupoActual: null,
              pending: {
                  grupos: new Set(),
                  articulos: new Set()
        }
    };

      const alertas = document.getElementById('alertas');

      const mostrarAlerta = (mensaje, tipo = 'danger') => {
          if (!mensaje) return;
          alertas.innerHTML = `<div class="alert alert-${tipo} alert-dismissible fade show" role="alert">${mensaje}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
      };

      const pendientesTotal = () => state.pending.grupos.size + state.pending.articulos.size;

        const renderSugerenciasArticulos = () => {
            const lista = document.getElementById('listaArticulos');
            lista.innerHTML = state.articulosMaestro.map(a => `<option value="${a.ItemCode}" label="${a.ItemName}"></option>`).join('');
        };

        const seleccionarArticuloDesdeInput = () => {
            const val = document.getElementById('inputArticulo').value.trim();
            const encontrado = state.articulosMaestro.find(a => a.ItemCode.toLowerCase() === val.toLowerCase());
            state.articuloSeleccionado = encontrado || null;
            document.getElementById('articuloSeleccionado').textContent = encontrado ? `${encontrado.ItemCode} - ${encontrado.ItemName}` : '';
        };

        const buscarArticulosMaestro = async (termino) => {
            if (!termino || termino.length < 2) {
                state.articulosMaestro = [];
                renderSugerenciasArticulos();
                seleccionarArticuloDesdeInput();
                return;
            }

            const resp = await fetch(`/GrupoVan/ArticulosMaestro?search=${encodeURIComponent(termino)}`);
            const data = await resp.json();
            if (!data.registered) {
                mostrarAlerta(data.message || 'No se pudo buscar el catálogo de artículos');
                return;
            }
            state.articulosMaestro = JSON.parse(data.content || '[]');
            renderSugerenciasArticulos();
            seleccionarArticuloDesdeInput();
        };

    const actualizarHeader = () => {
        document.getElementById('headerTienda').textContent = state.tiendaActual?.PrjName || '-';
        document.getElementById('headerGrupo').textContent = state.grupoActual?.U_MGS_CL_GRPNOM || '-';
        document.getElementById('pendingBadge').textContent = pendientesTotal();
        document.getElementById('btnActualizarTodo').disabled = pendientesTotal() === 0;
    };

    const marcarPendiente = (tipo, lineId) => {
        state.pending[tipo].add(lineId);
        actualizarHeader();
    };

    const limpiarPendientes = () => {
        state.pending.grupos.clear();
        state.pending.articulos.clear();
        actualizarHeader();
    };

    const cargarTiendas = async () => {
        const resp = await fetch(`/GrupoVan/Tiendas`);
        const data = await resp.json();
        if (!data.registered) {
            mostrarAlerta(data.message || 'No se pudieron cargar las tiendas');
            return;
        }
        state.tiendas = JSON.parse(data.content || '[]');
        renderTiendas();
    };

    const renderTiendas = () => {
        const cont = document.getElementById('tiendasLista');
        cont.innerHTML = '';
        const filtro = document.getElementById('buscarTienda').value?.toLowerCase() || '';
        state.tiendas
            .filter(t => t.PrjCode.toLowerCase().includes(filtro) || t.PrjName.toLowerCase().includes(filtro))
            .forEach(t => {
                const btn = document.createElement('button');
                btn.className = 'list-group-item list-group-item-action';
                btn.textContent = `${t.PrjCode} - ${t.PrjName}`;
                btn.onclick = () => seleccionarTienda(t);
                if (state.tiendaActual?.PrjCode === t.PrjCode) btn.classList.add('active');
                cont.appendChild(btn);
            });
    };

    const seleccionarTienda = (tienda) => {
        if (pendientesTotal() > 0) {
            const modal = new bootstrap.Modal(document.getElementById('modalCambios'));
            document.getElementById('btnDescartar').onclick = () => {
                limpiarPendientes();
                modal.hide();
                cambiarTienda(tienda);
            };
            modal.show();
            return;
        }
        cambiarTienda(tienda);
    };

    const cambiarTienda = async (tienda) => {
        state.tiendaActual = tienda;
        state.grupoActual = null;
        actualizarHeader();
        await cargarGruposTienda();
        renderGrupos();
        renderArticulos([]);
        renderTiendas();
    };

    const cargarGruposTienda = async () => {
        if (!state.tiendaActual) return;
        const resp = await fetch(`/GrupoVan/GruposPorTienda?tienda=${state.tiendaActual.PrjCode}`);
        const data = await resp.json();
        if (!data.registered) {
            mostrarAlerta(data.message || 'No se pudieron cargar los grupos de la tienda');
            return;
        }
        state.gruposTienda = JSON.parse(data.content || '[]');
        state.gruposTienda.forEach(g => {
            if (!g.U_MGS_CL_GRPNOM) {
                g.U_MGS_CL_GRPNOM = state.gruposMaestro.find(m => m.Code === g.U_MGS_CL_GRPCOD)?.Name || '';
            }
        });
    };

      const renderGrupos = () => {
          const tbody = document.querySelector('#tablaGrupos tbody');
          tbody.innerHTML = '';
          state.gruposTienda.forEach(g => {
              const tr = document.createElement('tr');
              if (state.pending.grupos.has(g.LineId)) tr.classList.add('fila-pendiente');

              const tdNombre = document.createElement('td');
              tdNombre.className = 'sticky-col';
              const nombre = g.U_MGS_CL_GRPNOM || state.gruposMaestro.find(x => x.Code === g.U_MGS_CL_GRPCOD)?.Name || '';
              tdNombre.textContent = `${g.U_MGS_CL_GRPCOD}${nombre ? ' - ' + nombre : ''}`;
              tdNombre.onclick = () => seleccionarGrupo(g);

            const tdAccion = document.createElement('td');
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline-danger btn-sm';
            btn.textContent = 'Quitar';
            btn.disabled = !!g.DocEntry;
            btn.onclick = () => {
                const idx = state.gruposTienda.findIndex(x => x.LineId === g.LineId);
                if (idx >= 0) {
                    state.gruposTienda.splice(idx,1);
                    state.pending.grupos.delete(g.LineId);
                    renderGrupos();
                    actualizarHeader();
                }
            };
            tdAccion.appendChild(btn);

            tr.append(tdNombre, tdAccion);
            tbody.appendChild(tr);
        });
    };

    const seleccionarGrupo = async (grupo) => {
        if (pendientesTotal() > 0 && state.grupoActual && state.grupoActual.LineId !== grupo.LineId) {
            const modal = new bootstrap.Modal(document.getElementById('modalCambios'));
            document.getElementById('btnDescartar').onclick = () => {
                limpiarPendientes();
                modal.hide();
                cambiarGrupo(grupo);
            };
            modal.show();
            return;
        }
        cambiarGrupo(grupo);
    };

    const cambiarGrupo = async (grupo) => {
        state.grupoActual = grupo;
        actualizarHeader();
        await cargarArticulosGrupo();
        renderArticulos(state.articulosGrupo);
    };

    const cargarArticulosGrupo = async () => {
        if (!state.grupoActual) return;
        const resp = await fetch(`/GrupoVan/ArticulosPorGrupo?grupo=${state.grupoActual.U_MGS_CL_GRPCOD}`);
        const data = await resp.json();
        if (!data.registered) {
            mostrarAlerta(data.message || 'No se pudieron cargar los artículos del grupo');
            return;
        }
        state.articulosGrupo = JSON.parse(data.content || '[]');
    };

      const renderArticulos = (lista) => {
        const tbody = document.querySelector('#tablaArticulos tbody');
        tbody.innerHTML = '';
          lista.forEach(a => {
              const tr = document.createElement('tr');
              if (state.pending.articulos.has(a.LineId)) tr.classList.add('fila-pendiente');

              const tdCodigo = document.createElement('td'); tdCodigo.className = 'sticky-col'; tdCodigo.textContent = a.U_MGS_CL_ITEMCOD;
              const tdNombre = document.createElement('td'); tdNombre.textContent = a.U_MGS_CL_ITEMNAM;

            const tdAccion = document.createElement('td');
            const btn = document.createElement('button'); btn.className='btn btn-outline-danger btn-sm'; btn.textContent='Quitar';
            btn.disabled = !!a.DocEntry;
            btn.onclick = () => {
                const idx = state.articulosGrupo.findIndex(x => x.LineId === a.LineId);
                if (idx >= 0) {
                    state.articulosGrupo.splice(idx,1);
                    state.pending.articulos.delete(a.LineId);
                    renderArticulos(state.articulosGrupo);
                    actualizarHeader();
                }
            };
            tdAccion.appendChild(btn);

            tr.append(tdCodigo, tdNombre, tdAccion);
            tbody.appendChild(tr);
        });
    };

    const agregarGrupo = () => {
        if (!state.tiendaActual) return;
        const grp = state.gruposMaestro.find(g => g.Code === document.getElementById('selectGrupoMaestro').value);
        if (!grp) return;
        if (state.gruposTienda.some(x => x.U_MGS_CL_GRPCOD === grp.Code)) { mostrarAlerta('El grupo ya está asignado a la tienda'); return; }
        const nuevo = { DocEntry: null, LineId: Date.now(), U_MGS_CL_GRPCOD: grp.Code, U_MGS_CL_GRPNOM: grp.Name };
        state.gruposTienda.push(nuevo);
        marcarPendiente('grupos', nuevo.LineId);
        renderGrupos();
    };

    const agregarArticulo = () => {
        if (!state.grupoActual) return;
        seleccionarArticuloDesdeInput();
        const codigo = state.articuloSeleccionado?.ItemCode;
        const nombre = state.articuloSeleccionado?.ItemName;
        if (!codigo || !nombre) { mostrarAlerta('Selecciona un artículo válido'); return; }
        if (state.articulosGrupo.some(x => x.U_MGS_CL_ITEMCOD === codigo)) { mostrarAlerta('El artículo ya está en el grupo'); return; }
        const nuevo = { DocEntry: null, LineId: Date.now(), U_MGS_CL_ITEMCOD: codigo, U_MGS_CL_ITEMNAM: nombre };
        state.articulosGrupo.push(nuevo);
        marcarPendiente('articulos', nuevo.LineId);
        renderArticulos(state.articulosGrupo);
        state.articuloSeleccionado = null;
        state.articulosMaestro = [];
        document.getElementById('articuloSeleccionado').textContent = '';
        document.getElementById('inputArticulo').value = '';
        renderSugerenciasArticulos();
    };

      const actualizarTodo = async () => {
          if (!state.tiendaActual) return;
          const payloadGrupos = {
              items: state.gruposTienda
                .filter(g => state.pending.grupos.has(g.LineId))
                .map(g => ({
                    DocEntry: g.DocEntry,
                    LineId: g.LineId,
                    U_MGS_CL_GRPCOD: g.U_MGS_CL_GRPCOD,
                    U_MGS_CL_GRPNOM: g.U_MGS_CL_GRPNOM
                }))
        };
        const payloadArts = {
            items: state.articulosGrupo
                .filter(a => state.pending.articulos.has(a.LineId))
                .map(a => ({
                    DocEntry: a.DocEntry,
                    LineId: a.LineId,
                    U_MGS_CL_ITEMCOD: a.U_MGS_CL_ITEMCOD,
                    U_MGS_CL_ITEMNAM: a.U_MGS_CL_ITEMNAM
                }))
        };

        const mensajes = [];

        if (payloadGrupos.items.length > 0) {
            const resp = await fetch(`/GrupoVan/GuardarGruposPorTienda?prjCode=${state.tiendaActual.PrjCode}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payloadGrupos) });
            const data = await resp.json();
            if (!data.registered) { mostrarAlerta(data.message || 'No se pudieron actualizar los grupos'); return; }
            mensajes.push(data.message || 'Grupos actualizados');
        }

        if (state.grupoActual && payloadArts.items.length > 0) {
            const resp = await fetch(`/GrupoVan/GuardarArticulosPorGrupo?grpCode=${state.grupoActual.U_MGS_CL_GRPCOD}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payloadArts) });
            const data = await resp.json();
            if (!data.registered) { mostrarAlerta(data.message || 'No se pudieron actualizar los artículos'); return; }
            mensajes.push(data.message || 'Artículos actualizados');
        }

        limpiarPendientes();
          if (mensajes.length) mostrarAlerta(mensajes.join(' | '), 'success');
      };

      document.addEventListener('DOMContentLoaded', async () => {
          document.getElementById('buscarTienda').oninput = renderTiendas;
          document.getElementById('btnAgregarGrupo').onclick = agregarGrupo;
          document.getElementById('btnAgregarArticulo').onclick = agregarArticulo;
          document.getElementById('btnActualizarTodo').onclick = actualizarTodo;
          document.getElementById('inputArticulo').oninput = (e) => { buscarArticulosMaestro(e.target.value); seleccionarArticuloDesdeInput(); };
          document.getElementById('inputArticulo').onchange = seleccionarArticuloDesdeInput;

          const respMaestro = await fetch(`/GrupoVan/GruposMaestro`);
          const dataMaestro = await respMaestro.json();
          if (!dataMaestro.registered) {
              mostrarAlerta(dataMaestro.message || 'No se pudo cargar el maestro de grupos');
              return;
        }
        state.gruposMaestro = JSON.parse(dataMaestro.content || '[]');
        const select = document.getElementById('selectGrupoMaestro');
        select.innerHTML = '<option value="">Grupo VAN</option>' + state.gruposMaestro.map(g => `<option value="${g.Code}">${g.Code} - ${g.Name}</option>`).join('');

        await cargarTiendas();
    });
</script>
