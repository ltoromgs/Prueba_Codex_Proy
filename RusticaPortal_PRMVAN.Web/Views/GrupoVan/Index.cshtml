@{
    ViewData["Title"] = "Grupos VAN";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid" id="grupos-van-app">
    <div class="d-flex align-items-center justify-content-between bg-light border rounded p-3 sticky-top" style="top: 70px; z-index: 1030;">
        <div>
            <div class="fw-bold">Tienda seleccionada: <span id="headerTienda">-</span></div>
            <div>Grupo VAN seleccionado: <span id="headerGrupo">-</span></div>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div class="d-flex align-items-center gap-1">
                <span class="text-secondary">Pendientes</span>
                <span class="badge bg-warning text-dark" id="pendingBadge">0</span>
            </div>
            <button id="btnActualizarTodo" class="btn btn-primary" disabled>Actualizar todo</button>
        </div>
    </div>

    <div id="alertas" class="mt-3"></div>

    <div class="row mt-3">
        <div class="col-md-3 mb-3">
            <div class="card h-100 shadow-sm">
                <div class="card-header">Tiendas</div>
                <div class="card-body d-flex flex-column">
                    <input type="text" id="buscarTienda" class="form-control mb-2" placeholder="Buscar tienda" />
                    <div id="tiendasLista" class="list-group flex-grow-1 overflow-auto" style="max-height: 70vh;"></div>
                </div>
            </div>
        </div>

        <div class="col-md-5 mb-3">
            <div class="card h-100 shadow-sm">
                <div class="card-header">Grupo VAN por tienda</div>
                <div class="card-body d-flex flex-column">
                    <div class="row g-2 mb-2">
                        <div class="col-sm-5">
                            <select id="selectGrupoMaestro" class="form-select"></select>
                        </div>
                        <div class="col-sm-3">
                            <select id="selectTipoGrupo" class="form-select"></select>
                        </div>
                        <div class="col-sm-2">
                            <input id="inputPorcentajeGrupo" type="number" class="form-control" placeholder="%" min="0" max="100" value="100" />
                        </div>
                        <div class="col-sm-2 d-grid">
                            <button id="btnAgregarGrupo" class="btn btn-success">+</button>
                        </div>
                    </div>
                    <div class="table-responsive position-relative flex-grow-1" style="max-height: 65vh;">
                        <table class="table table-sm table-bordered align-middle" id="tablaGrupos">
                            <thead class="table-light">
                                <tr>
                                    <th class="sticky-col">Grupo VAN</th>
                                    <th>Tipo</th>
                                    <th>%</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card h-100 shadow-sm">
                <div class="card-header">Asignación de artículos VAN</div>
                <div class="card-body d-flex flex-column">
                    <div class="row g-2 mb-2">
                        <div class="col-sm-4">
                            <input id="inputArticulo" class="form-control" placeholder="Código o nombre" list="listaArticulos" autocomplete="off" />
                            <datalist id="listaArticulos"></datalist>
                            <small class="text-muted" id="articuloSeleccionado"></small>
                        </div>
                        <div class="col-sm-3">
                            <select id="selectTipoArticulo" class="form-select"></select>
                        </div>
                        <div class="col-sm-3">
                            <input id="inputPorcentajeArticulo" type="number" class="form-control" placeholder="%" min="0" max="100" value="100" />
                        </div>
                        <div class="col-sm-2 d-grid">
                            <button id="btnAgregarArticulo" class="btn btn-success">+</button>
                        </div>
                    </div>
                    <div class="table-responsive position-relative flex-grow-1" style="max-height: 65vh;">
                        <div class="text-info small" id="infoArticulos"></div>
                        <table class="table table-sm table-bordered align-middle" id="tablaArticulos">
                            <thead class="table-light">
                                <tr>
                                    <th class="sticky-col">Código</th>
                                    <th>Descripción</th>
                                    <th>Tipo</th>
                                    <th>%</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalCambios" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cambios pendientes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Hay cambios pendientes sin guardar. ¿Deseas descartarlos?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Volver</button>
                    <button type="button" class="btn btn-danger" id="btnDescartar">Descartar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .sticky-col {
        position: sticky;
        left: 0;
        background: #fff;
        z-index: 2;
    }
    .fila-pendiente {
        background-color: #fff3cd !important;
    }
    .fila-activa {
        background-color: #cfe2ff !important; /* destaca la fila seleccionada sin romper el DOM */
    }
    #loadingOverlay {
        background: rgba(255,255,255,0.7);
        z-index: 9999;
    }
</style>

      <script>
          const state = {
              tiendas: [],
              gruposMaestro: [],
              tipos: [],
              gruposTienda: [],
              articulosGrupo: [],
              articulosMaestro: [],
              articuloSeleccionado: null,
              tiendaActual: null,
              grupoActual: null,
              camposTipoPorcDisponibles: true,
              pending: {
                  grupos: new Set(),
                  articulos: new Set()
              }
          };
          let tempGrupoId = 1;
          let tempArticuloId = 1;

      const alertas = document.getElementById('alertas');
      const overlay = document.createElement('div');
      overlay.id = 'loadingOverlay';
      overlay.className = 'position-fixed top-0 start-0 w-100 h-100 d-none d-flex align-items-center justify-content-center';
      overlay.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>';
      document.body.appendChild(overlay);

          const setLoading = (flag) => {
              state.loading = flag;
              overlay.classList.toggle('d-none', !flag);
          };

      const siguienteLineId = (lista) => {
          const maxActual = lista.reduce((max, item) => {
              const val = Number(item.LineId) || 0;
              return val > max ? val : max;
          }, 0);
          return maxActual + 1;
      };

      const mostrarAlerta = (mensaje, tipo = 'danger') => {
          if (!mensaje) return;
          alertas.innerHTML = `<div class="alert alert-${tipo} alert-dismissible fade show" role="alert">${mensaje}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
      };

      const fetchJson = async (url, options = {}, contexto = 'operación') => {
          setLoading(true);
          try {
              const resp = await fetch(url, options);
              if (!resp.ok) {
                  mostrarAlerta(`Error ${contexto}: ${resp.status}`);
                  return null;
              }
              const data = await resp.json();
              return data;
          } catch (err) {
              mostrarAlerta(`Error ${contexto}: ${err.message}`);
              return null;
          } finally {
              setLoading(false);
          }
      };

      const pendientesTotal = () => state.pending.grupos.size + state.pending.articulos.size;

        const rowKeyGrupo = (g) => {
            if (g.DocEntry) return `${g.DocEntry}_${g.LineId}`;
            if (!g._tempId) g._tempId = `G${tempGrupoId++}`;
            return `NEW_${g._tempId}`;
        };

        const rowKeyArticulo = (a) => {
            if (a.DocEntry) return `${a.DocEntry}_${a.LineId}`;
            if (!a._tempId) a._tempId = `A${tempArticuloId++}`;
            return `NEW_${a._tempId}`;
        };

        // Evita que los clicks en controles internos disparen el selector de fila y cierren el dropdown.
        const silenciarPropagacion = (el) => ['click', 'mousedown', 'touchstart', 'focus'].forEach(evt => el.addEventListener(evt, e => e.stopPropagation()));

        const renderSugerenciasArticulos = () => {
            const lista = document.getElementById('listaArticulos');
            lista.innerHTML = state.articulosMaestro.map(a => `<option value="${a.ItemCode}" label="${a.ItemName}"></option>`).join('');
        };

        const seleccionarArticuloDesdeInput = () => {
            const val = document.getElementById('inputArticulo').value.trim();
            const encontrado = state.articulosMaestro.find(a => a.ItemCode.toLowerCase() === val.toLowerCase());
            state.articuloSeleccionado = encontrado || null;
            document.getElementById('articuloSeleccionado').textContent = encontrado ? `${encontrado.ItemCode} - ${encontrado.ItemName}` : '';
        };

        const buscarArticulosMaestro = async (termino) => {
            if (!termino || termino.length < 2) {
                state.articulosMaestro = [];
                renderSugerenciasArticulos();
                seleccionarArticuloDesdeInput();
                return;
            }

            const data = await fetchJson(`/GrupoVan/ArticulosMaestro?search=${encodeURIComponent(termino)}`, {}, 'al buscar artículos');
            if (!data) return;
            if (!data.registered) {
                mostrarAlerta(data.message || 'No se pudo buscar el catálogo de artículos');
                return;
            }
            state.articulosMaestro = JSON.parse(data.content || '[]');
            renderSugerenciasArticulos();
            seleccionarArticuloDesdeInput();
        };

        const llenarComboTipos = () => {
            const opciones = ['<option value="">Tipo</option>', ...state.tipos.map(t => `<option value="${t.Code}">${t.Name}</option>`)];
            ['selectTipoGrupo', 'selectTipoArticulo'].forEach(id => {
                const sel = document.getElementById(id);
                if (sel) sel.innerHTML = opciones.join('');
            });
        };

        const asegurarPorcentajePorDefecto = (input) => {
            const valor = parseFloat(input.value);
            if (isNaN(valor) || valor <= 0) {
                input.value = '100';
                return 100;
            }
            return valor;
        };

        const notificarCamposTipoPorc = () => {
            if (!state.camposTipoPorcDisponibles) {
                mostrarAlerta('Faltan campos en UDO para Tipo / %');
            }
        };

    const actualizarHeader = () => {
        document.getElementById('headerTienda').textContent = state.tiendaActual?.PrjName || '-';
        const nombreGrupo = state.grupoActual?.U_MGS_CL_GRPNOM || state.gruposMaestro.find(m => m.Code === state.grupoActual?.U_MGS_CL_GRPCOD)?.Name || '-';
        document.getElementById('headerGrupo').textContent = nombreGrupo || '-';
        document.getElementById('pendingBadge').textContent = pendientesTotal();
        document.getElementById('btnActualizarTodo').disabled = pendientesTotal() === 0;
    };

    const marcarPendiente = (tipo, key) => {
        state.pending[tipo].add(key);
        actualizarHeader();
    };

    const limpiarPendientes = () => {
        state.pending.grupos.clear();
        state.pending.articulos.clear();
        actualizarHeader();
    };

    const cargarTiendas = async () => {
        const data = await fetchJson(`/GrupoVan/Tiendas`, {}, 'al cargar tiendas');
        if (!data) return;
        if (!data.registered) {
            mostrarAlerta(data.message || 'No se pudieron cargar las tiendas');
            return;
        }
        state.tiendas = JSON.parse(data.content || '[]');
        renderTiendas();
    };

    const renderTiendas = () => {
        const cont = document.getElementById('tiendasLista');
        cont.innerHTML = '';
        const filtro = document.getElementById('buscarTienda').value?.toLowerCase() || '';
        state.tiendas
            .filter(t => t.PrjCode.toLowerCase().includes(filtro) || t.PrjName.toLowerCase().includes(filtro))
            .forEach(t => {
                const btn = document.createElement('button');
                btn.className = 'list-group-item list-group-item-action';
                btn.textContent = `${t.PrjCode} - ${t.PrjName}`;
                btn.onclick = () => seleccionarTienda(t);
                if (state.tiendaActual?.PrjCode === t.PrjCode) btn.classList.add('active');
                cont.appendChild(btn);
            });
    };

    const seleccionarTienda = (tienda) => {
        if (pendientesTotal() > 0) {
            const modal = new bootstrap.Modal(document.getElementById('modalCambios'));
            document.getElementById('btnDescartar').onclick = async () => {
                await descartarYRecargar();
                modal.hide();
                cambiarTienda(tienda);
            };
            modal.show();
            return;
        }
        cambiarTienda(tienda);
    };

    const recargarDatosActuales = async () => {
        await cargarGruposTienda();
        if (state.grupoActual) {
            const match = state.gruposTienda.find(g => g.U_MGS_CL_GRPCOD === state.grupoActual.U_MGS_CL_GRPCOD && g.LineId === state.grupoActual.LineId && g.DocEntry === state.grupoActual.DocEntry);
            state.grupoActual = match || null;
        }
        renderGrupos();
        if (state.grupoActual) {
            await cargarArticulosGrupo();
            renderArticulos(state.articulosGrupo);
        } else {
            renderArticulos([]);
        }
        actualizarHeader();
    };

    const descartarYRecargar = async () => {
        limpiarPendientes();
        await recargarDatosActuales();
    };

    const cambiarTienda = async (tienda) => {
        state.tiendaActual = tienda;
        state.grupoActual = null;
        state.camposTipoPorcDisponibles = true;
        actualizarHeader();
        await cargarGruposTienda();
        renderGrupos();
        renderArticulos([]);
        renderTiendas();
        notificarCamposTipoPorc();
    };

    const cargarGruposTienda = async () => {
        if (!state.tiendaActual) return;
        const data = await fetchJson(`/GrupoVan/GruposPorTienda?tienda=${state.tiendaActual.PrjCode}`, {}, 'al cargar grupos');
        if (!data) return;
        if (!data.registered) {
            mostrarAlerta(data.message || 'No se pudieron cargar los grupos de la tienda');
            return;
        }
        state.gruposTienda = JSON.parse(data.content || '[]');
        state.gruposTienda.forEach(g => {
            g.rowKey = rowKeyGrupo(g);
            if (typeof g.U_MGS_CL_ACTIVO === 'undefined') g.U_MGS_CL_ACTIVO = 'SI';
        });
        const tieneCampos = state.gruposTienda.some(g => 'U_MGS_CL_TIPO' in g || 'U_MGS_CL_PORC' in g);
        if (state.gruposTienda.length > 0 && !tieneCampos) {
            state.camposTipoPorcDisponibles = false;
        }
        state.gruposTienda.forEach(g => {
            if (!g.U_MGS_CL_GRPNOM) {
                g.U_MGS_CL_GRPNOM = state.gruposMaestro.find(m => m.Code === g.U_MGS_CL_GRPCOD)?.Name || '';
            }
            if (typeof g.U_MGS_CL_PORC === 'undefined') g.U_MGS_CL_PORC = '';
            if (typeof g.U_MGS_CL_TIPO === 'undefined') g.U_MGS_CL_TIPO = '';
        });
    };

      const renderGrupos = () => {
          const tbody = document.querySelector('#tablaGrupos tbody');
          tbody.innerHTML = '';
          state.gruposTienda.forEach(g => {
              g.rowKey = g.rowKey || rowKeyGrupo(g);
              const tr = document.createElement('tr');
              if (state.pending.grupos.has(g.rowKey)) tr.classList.add('fila-pendiente');
              if (state.grupoActual?.LineId === g.LineId) tr.classList.add('fila-activa');
              if (g._toDelete) tr.classList.add('table-danger');

              tr.onclick = () => seleccionarGrupo(g);

              const tdNombre = document.createElement('td');
              tdNombre.className = 'sticky-col';
              const nombre = g.U_MGS_CL_GRPNOM || state.gruposMaestro.find(x => x.Code === g.U_MGS_CL_GRPCOD)?.Name || '';
              tdNombre.textContent = `${g.U_MGS_CL_GRPCOD}${nombre ? ' - ' + nombre : ''}`;

              const tdTipo = document.createElement('td');
              const selTipo = document.createElement('select');
              selTipo.className = 'form-select form-select-sm';
              selTipo.innerHTML = ['<option value="">Tipo</option>', ...state.tipos.map(t => `<option value="${t.Code}">${t.Name}</option>`)].join('');
              selTipo.value = g.U_MGS_CL_TIPO || '';
              silenciarPropagacion(selTipo);
              selTipo.onchange = (e) => {
                  e.stopPropagation();
                  g.U_MGS_CL_TIPO = e.target.value;
                  g.U_MGS_CL_ACTIVO = 'SI';
                  if (!g.U_MGS_CL_PORC || Number(g.U_MGS_CL_PORC) === 0) {
                      g.U_MGS_CL_PORC = 100;
                      const inp = tr.querySelector('input[data-lineid="' + g.LineId + '-grupo"]');
                      if (inp) inp.value = 100;
                  }
                  marcarPendiente('grupos', g.rowKey);
                  tr.classList.add('fila-pendiente');
              };
              tdTipo.appendChild(selTipo);

              const tdPorc = document.createElement('td');
              const inpPorc = document.createElement('input');
              inpPorc.type = 'number';
              inpPorc.min = '0';
              inpPorc.max = '100';
              inpPorc.className = 'form-control form-control-sm';
              inpPorc.dataset.lineid = `${g.LineId}-grupo`;
              inpPorc.value = g.U_MGS_CL_PORC ?? '';
              silenciarPropagacion(inpPorc);
              inpPorc.onchange = (e) => {
                  e.stopPropagation();
                  g.U_MGS_CL_PORC = asegurarPorcentajePorDefecto(e.target);
                  g.U_MGS_CL_ACTIVO = 'SI';
                  marcarPendiente('grupos', g.rowKey);
                  tr.classList.add('fila-pendiente');
              };
              tdPorc.appendChild(inpPorc);

            const tdAccion = document.createElement('td');
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline-danger btn-sm';
            btn.textContent = 'Quitar';
            silenciarPropagacion(btn);
            btn.onclick = (ev) => {
                ev.preventDefault();
                ev.stopPropagation();
                const idx = state.gruposTienda.findIndex(x => x.rowKey === g.rowKey);
                if (idx >= 0) {
                    if (g.DocEntry) {
                        state.pending.grupos.add(g.rowKey); // conserva en el payload y marca eliminado
                        const target = state.gruposTienda[idx];
                        const marcadoEliminar = !!target._toDelete;
                        target._toDelete = !marcadoEliminar;
                        target.U_MGS_CL_ACTIVO = marcadoEliminar ? 'SI' : 'NO'; // toggle revert/quit
                        renderGrupos();
                        actualizarHeader();
                    } else {
                        state.pending.grupos.delete(g.rowKey); // eliminar pendiente si se descarta fila nueva
                        state.gruposTienda.splice(idx,1);
                        if (state.grupoActual?.LineId === g.LineId) {
                            state.grupoActual = null;
                            renderArticulos([]);
                        }
                        renderGrupos();
                        actualizarHeader();
                    }
                }
            };
            tdAccion.appendChild(btn);

            tr.append(tdNombre, tdTipo, tdPorc, tdAccion);
            tbody.appendChild(tr);
        });
    };

    const seleccionarGrupo = async (grupo) => {
        const hayPendArt = state.pending.articulos.size > 0;
        if (hayPendArt && state.grupoActual && state.grupoActual.LineId !== grupo.LineId) {
            const modal = new bootstrap.Modal(document.getElementById('modalCambios'));
            document.getElementById('btnDescartar').onclick = async () => {
                await descartarYRecargar();
                modal.hide();
                cambiarGrupo(grupo);
            };
            modal.show();
            return;
        }
        cambiarGrupo(grupo);
    };

    const cambiarGrupo = async (grupo) => {
        if (!grupo.U_MGS_CL_GRPNOM) {
            grupo.U_MGS_CL_GRPNOM = state.gruposMaestro.find(m => m.Code === grupo.U_MGS_CL_GRPCOD)?.Name || '';
        }
        state.grupoActual = grupo;
        actualizarHeader();
        renderGrupos();
        await cargarArticulosGrupo();
        renderArticulos(state.articulosGrupo);
        notificarCamposTipoPorc();
    };

    const cargarArticulosGrupo = async () => {
        if (!state.grupoActual) return;
        const data = await fetchJson(`/GrupoVan/ArticulosPorGrupo?grupo=${state.grupoActual.U_MGS_CL_GRPCOD}`, {}, 'al cargar artículos');
        if (!data) return;
        if (!data.registered) {
            mostrarAlerta(data.message || 'No se pudieron cargar los artículos del grupo');
            return;
        }
        state.articulosGrupo = JSON.parse(data.content || '[]');
        state.articulosGrupo.forEach(a => {
            a.rowKey = rowKeyArticulo(a);
            if (typeof a.U_MGS_CL_ACTIVO === 'undefined') a.U_MGS_CL_ACTIVO = 'SI';
        });
        const info = document.getElementById('infoArticulos');
        if (!state.articulosGrupo.length) {
            info.textContent = 'No hay artículos asignados a este grupo. Puedes agregarlos.';
        } else {
            info.textContent = '';
        }
        const tieneCampos = state.articulosGrupo.some(a => 'U_MGS_CL_TIPO' in a || 'U_MGS_CL_PORC' in a);
        if (state.articulosGrupo.length > 0 && !tieneCampos) {
            state.camposTipoPorcDisponibles = false;
        }
        state.articulosGrupo.forEach(a => {
            if (typeof a.U_MGS_CL_PORC === 'undefined') a.U_MGS_CL_PORC = '';
            if (typeof a.U_MGS_CL_TIPO === 'undefined') a.U_MGS_CL_TIPO = '';
        });
    };

      const renderArticulos = (lista) => {
        const tbody = document.querySelector('#tablaArticulos tbody');
        tbody.innerHTML = '';
        const info = document.getElementById('infoArticulos');
        info.textContent = (!lista || lista.length === 0) ? 'No hay artículos asignados a este grupo. Puedes agregarlos.' : '';
          lista.forEach(a => {
              a.rowKey = a.rowKey || rowKeyArticulo(a);
              const tr = document.createElement('tr');
              if (state.pending.articulos.has(a.rowKey)) tr.classList.add('fila-pendiente');
              if (a._toDelete) tr.classList.add('table-danger');

              const tdCodigo = document.createElement('td'); tdCodigo.className = 'sticky-col'; tdCodigo.textContent = a.U_MGS_CL_ITEMCOD;
              const tdNombre = document.createElement('td'); tdNombre.textContent = a.U_MGS_CL_ITEMNAM;

              const tdTipo = document.createElement('td');
              const selTipo = document.createElement('select');
              selTipo.className = 'form-select form-select-sm';
              selTipo.innerHTML = ['<option value="">Tipo</option>', ...state.tipos.map(t => `<option value="${t.Code}">${t.Name}</option>`)].join('');
              selTipo.value = a.U_MGS_CL_TIPO || '';
              silenciarPropagacion(selTipo);
              selTipo.onchange = (e) => {
                  e.stopPropagation();
                  a.U_MGS_CL_TIPO = e.target.value;
                  a.U_MGS_CL_ACTIVO = 'SI';
                  if (!a.U_MGS_CL_PORC || Number(a.U_MGS_CL_PORC) === 0) {
                      a.U_MGS_CL_PORC = 100;
                      const inp = tr.querySelector('input[data-lineid="' + a.LineId + '-art"]');
                      if (inp) inp.value = 100;
                  }
                  marcarPendiente('articulos', a.rowKey);
                  tr.classList.add('fila-pendiente');
              };
              tdTipo.appendChild(selTipo);

              const tdPorc = document.createElement('td');
              const inpPorc = document.createElement('input');
              inpPorc.type = 'number';
              inpPorc.min = '0';
              inpPorc.max = '100';
              inpPorc.className = 'form-control form-control-sm';
              inpPorc.dataset.lineid = `${a.LineId}-art`;
              inpPorc.value = a.U_MGS_CL_PORC ?? '';
              silenciarPropagacion(inpPorc);
              inpPorc.onchange = (e) => {
                  e.stopPropagation();
                  a.U_MGS_CL_PORC = asegurarPorcentajePorDefecto(e.target);
                  a.U_MGS_CL_ACTIVO = 'SI';
                  marcarPendiente('articulos', a.rowKey);
                  tr.classList.add('fila-pendiente');
              };
              tdPorc.appendChild(inpPorc);

            const tdAccion = document.createElement('td');
            const btn = document.createElement('button'); btn.type='button'; btn.className='btn btn-outline-danger btn-sm'; btn.textContent='Quitar';
            silenciarPropagacion(btn);
            btn.onclick = (ev) => {
                ev.preventDefault();
                ev.stopPropagation();
                const idx = state.articulosGrupo.findIndex(x => x.rowKey === a.rowKey);
                if (idx >= 0) {
                    if (a.DocEntry) {
                        state.pending.articulos.add(a.rowKey); // conserva en payload como pendiente de baja
                        const target = state.articulosGrupo[idx];
                        const marcadoEliminar = !!target._toDelete;
                        target._toDelete = !marcadoEliminar;
                        target.U_MGS_CL_ACTIVO = marcadoEliminar ? 'SI' : 'NO';
                        renderArticulos(state.articulosGrupo);
                        actualizarHeader();
                    } else {
                        state.pending.articulos.delete(a.rowKey); // si era nuevo, retirar su pendiente al eliminarlo
                        state.articulosGrupo.splice(idx,1);
                        renderArticulos(state.articulosGrupo);
                        actualizarHeader();
                    }
                }
            };
            tdAccion.appendChild(btn);

            tr.append(tdCodigo, tdNombre, tdTipo, tdPorc, tdAccion);
            tbody.appendChild(tr);
        });
    };

    const agregarGrupo = () => {
        if (!state.tiendaActual) return;
        const grp = state.gruposMaestro.find(g => g.Code === document.getElementById('selectGrupoMaestro').value);
        const tipoSel = document.getElementById('selectTipoGrupo').value;
        const porcInput = document.getElementById('inputPorcentajeGrupo');
        asegurarPorcentajePorDefecto(porcInput);
        const porcSel = parseFloat(porcInput.value);
        if (!grp) return;
        if (!tipoSel) { mostrarAlerta('Selecciona un tipo de VAN para el grupo'); return; }
        if (state.gruposTienda.some(x => x.U_MGS_CL_GRPCOD === grp.Code)) { mostrarAlerta('El grupo ya está asignado a la tienda'); return; }
        const docEntryBase = state.gruposTienda.find(x => x.DocEntry)?.DocEntry ?? null;
        const nuevo = { DocEntry: docEntryBase, LineId: siguienteLineId(state.gruposTienda), U_MGS_CL_GRPCOD: grp.Code, U_MGS_CL_GRPNOM: grp.Name, U_MGS_CL_TIPO: tipoSel, U_MGS_CL_PORC: porcSel, U_MGS_CL_ACTIVO: 'SI' };
        nuevo.rowKey = rowKeyGrupo(nuevo);
        state.gruposTienda.push(nuevo);
        marcarPendiente('grupos', nuevo.rowKey);
        renderGrupos();
        seleccionarGrupo(nuevo);
        document.getElementById('selectGrupoMaestro').value = '';
        document.getElementById('selectTipoGrupo').value = '';
        document.getElementById('inputPorcentajeGrupo').value = '100';
    };

    const agregarArticulo = () => {
        if (!state.grupoActual) { mostrarAlerta('Primero selecciona un grupo VAN.'); return; }
        seleccionarArticuloDesdeInput();
        const codigo = state.articuloSeleccionado?.ItemCode;
        const nombre = state.articuloSeleccionado?.ItemName;
        const tipoSel = document.getElementById('selectTipoArticulo').value;
        const porcInput = document.getElementById('inputPorcentajeArticulo');
        asegurarPorcentajePorDefecto(porcInput);
        const porcSel = parseFloat(porcInput.value);
        if (!codigo || !nombre) { mostrarAlerta('Selecciona un artículo válido'); return; }
        if (!tipoSel) { mostrarAlerta('Selecciona un tipo para el artículo VAN'); return; }
        if (state.articulosGrupo.some(x => x.U_MGS_CL_ITEMCOD === codigo)) { mostrarAlerta('El artículo ya está en el grupo'); return; }
        const docEntryBase = state.articulosGrupo.find(x => x.DocEntry)?.DocEntry ?? state.grupoActual?.DocEntry ?? null;
        const nuevo = { DocEntry: docEntryBase, LineId: siguienteLineId(state.articulosGrupo), U_MGS_CL_ITEMCOD: codigo, U_MGS_CL_ITEMNAM: nombre, U_MGS_CL_TIPO: tipoSel, U_MGS_CL_PORC: porcSel, U_MGS_CL_ACTIVO: 'SI' };
        nuevo.rowKey = rowKeyArticulo(nuevo);
        state.articulosGrupo.push(nuevo);
        marcarPendiente('articulos', nuevo.rowKey);
        renderArticulos(state.articulosGrupo);
        state.articuloSeleccionado = null;
        state.articulosMaestro = [];
        document.getElementById('articuloSeleccionado').textContent = '';
        document.getElementById('inputArticulo').value = '';
        document.getElementById('selectTipoArticulo').value = '';
        document.getElementById('inputPorcentajeArticulo').value = '100';
        renderSugerenciasArticulos();
    };

      const actualizarTodo = async () => {
          if (!state.tiendaActual) return;
          const payloadGrupos = {
              items: state.gruposTienda
                .filter(g => state.pending.grupos.has(g.rowKey))
                .map(g => ({
                    DocEntry: g.DocEntry,
                    LineId: g.LineId,
                    U_MGS_CL_GRPCOD: g.U_MGS_CL_GRPCOD,
                    U_MGS_CL_GRPNOM: g.U_MGS_CL_GRPNOM,
                    U_MGS_CL_TIPO: g.U_MGS_CL_TIPO,
                    U_MGS_CL_PORC: g.U_MGS_CL_PORC,
                    U_MGS_CL_ACTIVO: g.U_MGS_CL_ACTIVO ?? 'SI'
                }))
        };
        const payloadArts = {
            items: state.articulosGrupo
                .filter(a => state.pending.articulos.has(a.rowKey))
                .map(a => ({
                    DocEntry: a.DocEntry,
                    LineId: a.LineId,
                    U_MGS_CL_ITEMCOD: a.U_MGS_CL_ITEMCOD,
                    U_MGS_CL_ITEMNAM: a.U_MGS_CL_ITEMNAM,
                    U_MGS_CL_TIPO: a.U_MGS_CL_TIPO,
                    U_MGS_CL_PORC: a.U_MGS_CL_PORC,
                    U_MGS_CL_ACTIVO: a.U_MGS_CL_ACTIVO ?? 'SI'
                }))
        };

        const mensajes = [];

        if (payloadGrupos.items.length > 0) {
            const data = await fetchJson(`/GrupoVan/GuardarGruposPorTienda?prjCode=${state.tiendaActual.PrjCode}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payloadGrupos) }, 'al guardar grupos');
            if (!data) return;
            if (!data.registered) { mostrarAlerta(data.message || 'No se pudieron actualizar los grupos'); return; }
            mensajes.push(data.message || 'Grupos actualizados');
        }

        if (state.grupoActual && payloadArts.items.length > 0) {
            const data = await fetchJson(`/GrupoVan/GuardarArticulosPorGrupo?grpCode=${state.grupoActual.U_MGS_CL_GRPCOD}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payloadArts) }, 'al guardar artículos');
            if (!data) return;
            if (!data.registered) { mostrarAlerta(data.message || 'No se pudieron actualizar los artículos'); return; }
            mensajes.push(data.message || 'Artículos actualizados');
        }

        limpiarPendientes();
          if (mensajes.length) mostrarAlerta(mensajes.join(' | '), 'success');
      };

      document.addEventListener('DOMContentLoaded', async () => {
          document.getElementById('buscarTienda').oninput = renderTiendas;
          document.getElementById('btnAgregarGrupo').onclick = (e) => { e.preventDefault(); e.stopPropagation(); agregarGrupo(); }; // evita disparar cambio de contexto ni modal al agregar
          document.getElementById('btnAgregarArticulo').onclick = agregarArticulo;
          document.getElementById('btnActualizarTodo').onclick = actualizarTodo;
          document.getElementById('inputArticulo').oninput = (e) => { buscarArticulosMaestro(e.target.value); seleccionarArticuloDesdeInput(); };
          document.getElementById('inputArticulo').onchange = seleccionarArticuloDesdeInput;
          document.getElementById('selectTipoGrupo').onchange = () => asegurarPorcentajePorDefecto(document.getElementById('inputPorcentajeGrupo'));
          document.getElementById('selectTipoArticulo').onchange = () => asegurarPorcentajePorDefecto(document.getElementById('inputPorcentajeArticulo'));

          const dataTipos = await fetchJson(`/GrupoVan/Tipos`, {}, 'al cargar tipos');
          if (!dataTipos) return;
          if (!dataTipos.registered) {
              mostrarAlerta(dataTipos.message || 'No se pudieron cargar los tipos VAN');
              return;
          }
          state.tipos = JSON.parse(dataTipos.content || '[]');
          llenarComboTipos();

          const dataMaestro = await fetchJson(`/GrupoVan/GruposMaestro`, {}, 'al cargar maestro de grupos');
          if (!dataMaestro) return;
          if (!dataMaestro.registered) {
              mostrarAlerta(dataMaestro.message || 'No se pudo cargar el maestro de grupos');
              return;
        }
        state.gruposMaestro = JSON.parse(dataMaestro.content || '[]');
        const select = document.getElementById('selectGrupoMaestro');
        select.innerHTML = '<option value="">Grupo VAN</option>' + state.gruposMaestro.map(g => `<option value="${g.Code}">${g.Code} - ${g.Name}</option>`).join('');

        await cargarTiendas();
    });
</script>
