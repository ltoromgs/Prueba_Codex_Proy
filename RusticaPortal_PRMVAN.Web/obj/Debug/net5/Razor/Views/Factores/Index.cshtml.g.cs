#pragma checksum "C:\Desarrollos Rustica\PRM Y VAN\CODEX\Prueba_Codex_Proy\RusticaPortal_PRMVAN.Web\Views\Factores\Index.cshtml" "{ff1816ec-aa5e-4d10-87f7-6f4963833460}" "50e3c25466edfd04921a56f1cc7def6b1940fdf0"
// <auto-generated/>
#pragma warning disable 1591
[assembly: global::Microsoft.AspNetCore.Razor.Hosting.RazorCompiledItemAttribute(typeof(AspNetCore.Views_Factores_Index), @"mvc.1.0.view", @"/Views/Factores/Index.cshtml")]
namespace AspNetCore
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.AspNetCore.Mvc.ViewFeatures;
#nullable restore
#line 2 "C:\Desarrollos Rustica\PRM Y VAN\CODEX\Prueba_Codex_Proy\RusticaPortal_PRMVAN.Web\Views\_ViewImports.cshtml"
using Microsoft.AspNetCore.Mvc.Rendering;

#line default
#line hidden
#nullable disable
    [global::Microsoft.AspNetCore.Razor.Hosting.RazorSourceChecksumAttribute(@"SHA1", @"50e3c25466edfd04921a56f1cc7def6b1940fdf0", @"/Views/Factores/Index.cshtml")]
    [global::Microsoft.AspNetCore.Razor.Hosting.RazorSourceChecksumAttribute(@"SHA1", @"fdb879290cabaefa5e86dea586e577bf462c7f4f", @"/Views/_ViewImports.cshtml")]
    public class Views_Factores_Index : global::Microsoft.AspNetCore.Mvc.Razor.RazorPage<RusticaPortal_PRMVAN.Web.Models.MatrizFactoresViewModel>
    {
        #pragma warning disable 1998
        public async override global::System.Threading.Tasks.Task ExecuteAsync()
        {
#nullable restore
#line 2 "C:\Desarrollos Rustica\PRM Y VAN\CODEX\Prueba_Codex_Proy\RusticaPortal_PRMVAN.Web\Views\Factores\Index.cshtml"
  
    Layout = "_Layout";
    ViewData["Title"] = "Matriz factores";

#line default
#line hidden
#nullable disable
            WriteLiteral(@"<!-- Header -->
<div class=""app-content-header"">
    <div class=""container-fluid"">
        <div class=""row align-items-center"">
            <div class=""col-sm-6"">
                <h3 class=""mb-0"">Matriz de factores</h3>
            </div>
            <div class=""col-sm-6"">
                <ol class=""breadcrumb float-sm-end"">
                    <li class=""breadcrumb-item""><a href=""/Home/Index"">Home</a></li>
                    <li class=""breadcrumb-item active"" aria-current=""page"">Matriz de factores</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Content -->
<div class=""app-content"">
    <div class=""container-fluid"">
        <div class=""card"">
            <div class=""card-header"">
                <div class=""row g-2 align-items-end"">
                    <!-- Periodo (month picker) -->
                    <div class=""col-auto"">
                        <label class=""form-label mb-1"">Periodo</label>
                        <div class=""input-group inp");
            WriteLiteral(@"ut-group-sm"">
                            <button class=""btn btn-outline-secondary"" type=""button"" id=""btnPeriodoAnterior"">
                                <i class=""bi bi-chevron-left""></i>
                            </button>
                            <input type=""month"" id=""filtroPeriodo"" class=""form-control form-control-sm""");
            BeginWriteAttribute("value", " value=\"", 1499, "\"", 1527, 1);
#nullable restore
#line 36 "C:\Desarrollos Rustica\PRM Y VAN\CODEX\Prueba_Codex_Proy\RusticaPortal_PRMVAN.Web\Views\Factores\Index.cshtml"
WriteAttributeValue("", 1507, Model.PeriodoActual, 1507, 20, false);

#line default
#line hidden
#nullable disable
            EndWriteAttribute();
            WriteLiteral(@" />
                            <button class=""btn btn-outline-secondary"" type=""button"" id=""btnPeriodoSiguiente"">
                                <i class=""bi bi-chevron-right""></i>
                            </button>
                        </div>
                    </div>

                    <!-- Tiendas: multiselección en dropdown, no se cierra al interactuar -->
                    <div class=""col-auto"">
                        <label class=""form-label mb-1"">Tiendas</label>
                        <div class=""dropdown"">
                            <button class=""btn btn-outline-secondary btn-sm dropdown-toggle"" type=""button""
                                    data-bs-toggle=""dropdown"" data-bs-auto-close=""outside"">
                                Seleccionar tiendas
                            </button>
                            <div class=""dropdown-menu p-3"" style=""max-height: 280px; overflow: auto; width: 320px;"">
                                <div id=""tiendasEstado"" class=""small");
            WriteLiteral(@" text-secondary mb-2"">Cargando tiendas...</div>
                                <div id=""tiendasListado"" class=""d-grid gap-1""></div>

                                <div class=""border-top pt-2 mt-2 d-flex justify-content-between"">
                                    <a href=""#"" id=""tiendaSelTodas"" class=""link-primary small"">Seleccionar todo</a>
                                    <a href=""#"" id=""tiendaLimpiar"" class=""link-secondary small"">Limpiar</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class=""col-auto ms-auto d-flex gap-2"">
                        <button id=""btnBuscar"" class=""btn btn-primary btn-sm"">
                            <i class=""bi bi-search""></i> Buscar
                        </button>
                        <button id=""btnNuevo"" class=""btn btn-outline-primary btn-sm"">
                            <i class=""bi bi-plus-circl");
            WriteLiteral(@"e""></i> Nuevo
                        </button>
                        <button id=""btnActualizarTodo"" class=""btn btn-success btn-sm"">
                            <i class=""bi bi-save""></i> Actualizar todo
                        </button>
                    </div>
                </div>
            </div>

            <div class=""card-body p-0"">
                <div id=""alertContainer"" class=""px-3 pt-3""></div>
                <div id=""loadingOverlay"" class=""loading-overlay d-none"">
                    <div class=""loading-box text-center"">
                        <div class=""spinner-border text-primary"" role=""status"">
                            <span class=""visually-hidden"">Procesando...</span>
                        </div>
                        <div id=""loadingMessage"" class=""mt-2 small text-primary"">Procesando...</div>
                    </div>
                </div>
                <!-- Tabla con scroll horizontal y columnas pegajosas -->
                <div class=""table-responsi");
            WriteLiteral(@"ve"" style=""overflow:auto;"">
                    <table class=""table table-sm table-hover table-bordered mb-0 align-middle"" id=""tablaMatriz"" style=""white-space:nowrap;"">
                        <thead class=""table-light"">
                            <tr>
                                <th>#</th>
                                <th class=""sticky-col-start"">Tienda</th>
                                <th>Meta<br />(UV)</th>
                                <th>Renta<br />(%)</th>
                                <th>VAN<br />(%)</th>
                                <th>PERS<br />(%)</th>
                                <th>Gtos<br />ADM (%)</th>
                                <th>Comisión<br />Tarjeta (%)</th>
                                <th>Impuesto<br />(%)</th>
                                <th>Regalías<br />(%)</th>
                                <th>AUD.<br />SERV</th>
                                <th>AUD.<br />OPER</th>
                                <th>AUD.<br />CC</th>
      ");
            WriteLiteral(@"                          <th>AUD.<br />ADH</th>
                                <th>CLIMA<br />LAB</th>
                                <th>CPTO<br />RUSTICA</th>
                                <th>META<br />LIDER</th>
                                <th>ADM.<br />GENERAL</th>
                                <th>FU. EXC<br />GESTION</th>
                                <th>FU. EXC<br />SERVICIO</th>
                                <th>FU. EXC<br />MARCA</th>
");
            WriteLiteral(@"                            </tr>
                        </thead>
                        <tbody>
                            <!-- Fila 1 -->
                            <!--<tr data-id=""1"">
                                <td>AUDI</td>
                                <td class=""sticky-col-start fw-semibold"">P0045</td>
                                <td>Mall Santa Anita</td>

                                <td contenteditable=""true"" class=""dec"" data-field=""MetaUV"">24</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""Renta"">6</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""VAN"">28</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""PERS"">10</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""GastosADM"">8</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""ComisionTarjeta"">1</td>
                               ");
            WriteLiteral(@" <td contenteditable=""true"" class=""dec"" data-field=""Impuesto"">18</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""Regalias"">5</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""AUD_SERV"">15</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""AUD_OPER"">12</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""AUD_CC"">16</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""AUD_ADH"">12</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""CLIMA_LAB"">12</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""CPTO_RUSTICA"">16</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""META_LIDER"">15</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""ADM_GENERAL"">15</td>
                             ");
            WriteLiteral(@"   <td contenteditable=""true"" class=""dec"" data-field=""FU_EXC_GESTION"">16</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""FU_EXC_SERVICIO"">15</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""FU_EXC_MARCA"">16</td>

                                <td class=""sticky-col-end text-center"">
                                    <button class=""btn btn-outline-secondary btn-xs me-1 btn-editar"" disabled title=""Edición en línea activa"">
                                        <i class=""bi bi-pencil-square""></i>
                                    </button>
                                    <button class=""btn btn-outline-danger btn-xs btn-eliminar""><i class=""bi bi-trash""></i></button>
                                </td>
                            </tr>-->
                            <!-- Fila 2 -->
                            <!--<tr data-id=""2"">
                                <td>PUW01</td>
                                <t");
            WriteLiteral(@"d class=""sticky-col-start fw-semibold"">P0031</td>
                                <td>Larcomar</td>

                                <td contenteditable=""true"" class=""dec"" data-field=""MetaUV"">23</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""Renta"">7</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""VAN"">27</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""PERS"">9</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""GastosADM"">8</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""ComisionTarjeta"">2</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""Impuesto"">18</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""Regalias"">6</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""AUD_SERV"">16</td>
             ");
            WriteLiteral(@"                   <td contenteditable=""true"" class=""dec"" data-field=""AUD_OPER"">12</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""AUD_CC"">16</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""AUD_ADH"">12</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""CLIMA_LAB"">12</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""CPTO_RUSTICA"">16</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""META_LIDER"">15</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""ADM_GENERAL"">15</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""FU_EXC_GESTION"">16</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""FU_EXC_SERVICIO"">15</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""FU_EXC_MARCA"">16");
            WriteLiteral(@"</td>

                                <td class=""sticky-col-end text-center"">
                                    <button class=""btn btn-outline-secondary btn-xs me-1 btn-editar"" disabled>
                                        <i class=""bi bi-pencil-square""></i>
                                    </button>
                                    <button class=""btn btn-outline-danger btn-xs btn-eliminar""><i class=""bi bi-trash""></i></button>
                                </td>
                            </tr>-->
                            <!-- Fila 3 -->
                            <!--<tr data-id=""3"">
                                <td>PUW02</td>
                                <td class=""sticky-col-start fw-semibold"">P0021</td>
                                <td>Miraflores</td>

                                <td contenteditable=""true"" class=""dec"" data-field=""MetaUV"">26</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""Renta"">6</td>
               ");
            WriteLiteral(@"                 <td contenteditable=""true"" class=""dec"" data-field=""VAN"">29</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""PERS"">11</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""GastosADM"">9</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""ComisionTarjeta"">3</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""Impuesto"">18</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""Regalias"">5</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""AUD_SERV"">15</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""AUD_OPER"">12</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""AUD_CC"">16</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""AUD_ADH"">12</td>
                          ");
            WriteLiteral(@"      <td contenteditable=""true"" class=""dec"" data-field=""CLIMA_LAB"">12</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""CPTO_RUSTICA"">16</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""META_LIDER"">15</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""ADM_GENERAL"">15</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""FU_EXC_GESTION"">16</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""FU_EXC_SERVICIO"">15</td>
                                <td contenteditable=""true"" class=""dec"" data-field=""FU_EXC_MARCA"">16</td>

                                <td class=""sticky-col-end text-center"">
                                    <button class=""btn btn-outline-secondary btn-xs me-1 btn-editar"" disabled>
                                        <i class=""bi bi-pencil-square""></i>
                                    </button>");
            WriteLiteral(@"
                                    <button class=""btn btn-outline-danger btn-xs btn-eliminar""><i class=""bi bi-trash""></i></button>
                                </td>
                            </tr>-->
                        </tbody>
                    </table>
                </div>

                <!-- Pie/acciones inferiores -->
                <div class=""d-flex justify-content-between align-items-center px-3 py-2 border-top"">
                    <div class=""d-flex flex-column"">
                        <small id=""lblResumen"" class=""text-secondary"">Mostrando 0 de 0</small>
                        <small id=""lblDocEntry"" class=""text-secondary"">DocEntry: --</small>
                    </div>
                    <a href=""/Home/Index"" class=""btn btn-outline-primary btn-sm"">
                        <i class=""bi bi-arrow-left-circle""></i> Regresar
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Cargar periodo anterio");
            WriteLiteral(@"r -->
<div class=""modal fade"" id=""modalNuevo"" tabindex=""-1"" aria-hidden=""true"">
    <div class=""modal-dialog modal-xl modal-dialog-scrollable"">
        <div class=""modal-content"">
            <div class=""modal-header bg-primary text-white"">
                <h5 class=""modal-title"">Cargar información del periodo anterior</h5>
                <button type=""button"" class=""btn-close btn-close-white"" data-bs-dismiss=""modal"" aria-label=""Close""></button>
            </div>
            <div class=""modal-body"">
                <p class=""mb-2 text-muted"" id=""nuevoDescripcion""></p>
                <div id=""nuevoEstado"" class=""alert alert-info d-none"" role=""alert""></div>
                <div class=""row g-3 align-items-end mb-3"">
                    <div class=""col-sm-4 col-md-3"">
                        <label class=""form-label mb-1"">Periodo destino</label>
                        <input type=""month"" id=""nuevoPeriodoDestino"" class=""form-control form-control-sm"" readonly />
                    </div>
      ");
            WriteLiteral(@"              <div class=""col-sm-5 col-md-5"">
                        <label class=""form-label mb-1"">Filtro por tienda</label>
                        <div class=""input-group input-group-sm"">
                            <input type=""text"" id=""nuevoFiltroTienda"" class=""form-control"" placeholder=""Buscar por código o nombre"" />
                            <button class=""btn btn-outline-secondary"" type=""button"" id=""btnFiltrarNuevo"">Filtrar</button>
                            <button class=""btn btn-outline-secondary"" type=""button"" id=""btnLimpiarFiltroNuevo"">Limpiar</button>
                        </div>
                    </div>
                </div>

                <div class=""table-responsive"" style=""max-height:60vh; overflow:auto;"">
                    <table class=""table table-sm table-hover table-bordered"" id=""tablaPreviewNuevo"" style=""white-space:nowrap;"">
                        <thead class=""table-light"">
                            <tr>
                                <th>#</th>
      ");
            WriteLiteral(@"                          <th class=""sticky-col-start"" style=""min-width:220px;"">Tienda<br />Nombre</th>
                                <th>Meta<br />(UV)</th>
                                <th>Renta<br />(%)</th>
                                <th>VAN<br />(%)</th>
                                <th>PERS<br />(%)</th>
                                <th>Gtos<br />ADM (%)</th>
                                <th>Comisión<br />Tarjeta (%)</th>
                                <th>Impuesto<br />(%)</th>
                                <th>Regalías<br />(%)</th>
                                <th>AUD.<br />SERV</th>
                                <th>AUD.<br />OPER</th>
                                <th>AUD.<br />CC</th>
                                <th>AUD.<br />ADH</th>
                                <th>CLIMA<br />LAB</th>
                                <th>CPTO<br />RUSTICA</th>
                                <th>META<br />LIDER</th>
                                <th>ADM.<br />");
            WriteLiteral(@"GENERAL</th>
                                <th>FU. EXC<br />GESTION</th>
                                <th>FU. EXC<br />SERVICIO</th>
                                <th>FU. EXC<br />MARCA</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <small class=""text-secondary d-block mt-2"">Los valores provienen del último periodo registrado y se crearán en el siguiente periodo.</small>
            </div>
            <div class=""modal-footer"">
                <button type=""button"" class=""btn btn-outline-secondary"" data-bs-dismiss=""modal"">Cancelar</button>
                <button type=""button"" class=""btn btn-primary"" id=""btnConfirmarNuevo"">
                    <i class=""bi bi-cloud-arrow-down""></i> Cargar información
                </button>
            </div>
        </div>
    </div>
</div>

");
            DefineSection("Scripts", async() => {
                WriteLiteral(@"
    <style>
        /* Columnas pegajosas para scroll horizontal cómodo (tres primeras y última) */
        .sticky-col-start {
            position: sticky;
            left: 0;
            z-index: 3;
            background: var(--bs-table-bg, #fff);
        }

        .sticky-col-start-2 {
            position: sticky;
            left: 140px;
            z-index: 3;
            background: var(--bs-table-bg, #fff);
        }

        .sticky-col-start-3 {
            position: sticky;
            left: 260px;
            z-index: 3;
            background: var(--bs-table-bg, #fff);
        }

        .sticky-col-end {
            position: sticky;
            right: 0;
            z-index: 3;
            background: var(--bs-table-bg, #fff);
        }
        /* Ajusta left de start-2 / start-3 si cambian anchos */
        th.sticky-col-start, td.sticky-col-start {
            min-width: 140px;
        }

        th.sticky-col-start-2, td.sticky-col-start-2 {
         ");
                WriteLiteral(@"   min-width: 120px;
        }

        th.sticky-col-start-3, td.sticky-col-start-3 {
            min-width: 180px;
        }

        .placeholder-row td {
            height: 36px;
            min-height: 36px;
            background-color: #f8f9fa;
        }

        .placeholder-cell {
            color: transparent;
        }

        /* Botón XS */
        .btn-xs {
            padding: .15rem .35rem;
            font-size: .75rem;
            line-height: 1;
            border-radius: .2rem;
        }

        /* Validación decimal */
        td.dec.is-invalid {
            outline: 2px solid #dc3545;
            background: #fde2e1;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2050;
        }

        .loading-box {
            background: #ffffff;
");
                WriteLiteral(@"            border-radius: .5rem;
            padding: 1rem 1.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
    </style>

    <script>
        const alertContainer = document.getElementById('alertContainer');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingMessage = document.getElementById('loadingMessage');
        const tiendasEstado = document.getElementById('tiendasEstado');
        const tiendasListado = document.getElementById('tiendasListado');
        const docEntryLabel = document.getElementById('lblDocEntry');
        let tiendasCache = [];
        let previewData = [];
        let modalNuevo;
        let nuevoPeriodoDestinoValor = '';
        let loadingCount = 0;

        function showAlert(message, type = 'success') {
            if (!alertContainer) { alert(message); return; }

            alertContainer.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper");
                WriteLiteral(@".className = `alert alert-${type} alert-dismissible fade show`;
            wrapper.role = 'alert';
            wrapper.innerHTML = `
                    <div>${message}</div>
                    <button type=""button"" class=""btn-close"" data-bs-dismiss=""alert"" aria-label=""Close""></button>`;

            alertContainer.appendChild(wrapper);
        }

        function clearAlert() {
            if (alertContainer) alertContainer.innerHTML = '';
        }

        function showLoading(message = 'Procesando...') {
            if (!loadingOverlay) return;
            loadingCount++;
            loadingMessage.textContent = message;
            loadingOverlay.classList.remove('d-none');
        }

        function hideLoading() {
            if (!loadingOverlay) return;
            loadingCount = Math.max(loadingCount - 1, 0);
            if (loadingCount === 0) loadingOverlay.classList.add('d-none');
        }

        function updateDocEntryInfo(docEntry) {
            if (!docEntryLabe");
                WriteLiteral(@"l) return;
            docEntryLabel.textContent = `DocEntry: ${docEntry || '--'}`;
        }

        function periodoAnterior(periodo) {
            if (!periodo) return '';
            const [anio, mes] = periodo.split('-').map(Number);
            const fecha = new Date(anio, (mes ?? 1) - 1, 1);
            fecha.setMonth(fecha.getMonth() - 1);
            return `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
        }

        function cambiarPeriodo(deltaMeses) {
            const input = document.getElementById('filtroPeriodo');
            const hoy = new Date();
            const [anio, mes] = (input?.value ?? `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`).split('-').map(Number);
            const fecha = new Date(anio || hoy.getFullYear(), (mes || (hoy.getMonth() + 1)) - 1, 1);
            fecha.setMonth(fecha.getMonth() + deltaMeses);
            if (input) input.value = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padS");
                WriteLiteral(@"tart(2, '0')}`;
        }

        // ---------- Utilidades de Tiendas ----------
        const checks = () => Array.from(document.querySelectorAll('.tienda-check'));

        async function cargarTiendas() {
            if (tiendasEstado) tiendasEstado.textContent = 'Cargando tiendas...';

            showLoading('Cargando tiendas...');

            try {
                const res = await fetch('/Factores/Tiendas');
                if (!res.ok) throw new Error('Error al obtener tiendas');

                const data = await res.json();
                renderTiendas(data);
            } catch (err) {
                console.error('ERROR TIENDAS:', err);
                if (tiendasEstado) tiendasEstado.textContent = 'No se pudieron cargar las tiendas.';
                if (tiendasListado) tiendasListado.innerHTML = '';
            } finally {
                hideLoading();
            }
        }

        function renderTiendas(lista) {
            if (!tiendasListado || !tiendasEsta");
                WriteLiteral(@"do) return;

            if (!Array.isArray(lista) || lista.length === 0) {
                tiendasEstado.textContent = 'No hay tiendas activas disponibles.';
                tiendasListado.innerHTML = '';
                return;
            }

            tiendasCache = lista;
            tiendasEstado.textContent = 'Marca una o más tiendas';
            tiendasListado.innerHTML = lista.map(t => {
                const codigo = t.codigo ?? t.Codigo ?? '';
                const nombre = t.nombre ?? t.Nombre ?? '';
                const id = `t_${codigo}`;

                return `
                        <div class=""form-check"">
                            <input class=""form-check-input tienda-check"" type=""checkbox"" value=""${codigo}"" id=""${id}"" checked>
                            <label class=""form-check-label"" for=""${id}"">${codigo} - ${nombre}</label>
                        </div>`;
            }).join('');
        }

        document.getElementById('tiendaSelTodas')?.addEventListene");
                WriteLiteral(@"r('click', (e) => {
            e.preventDefault();
            checks().forEach(ch => ch.checked = true);
        });
        document.getElementById('tiendaLimpiar')?.addEventListener('click', (e) => {
            e.preventDefault();
            checks().forEach(ch => ch.checked = false);
        });

        // ---------- Validación / Formato de decimales ----------
        const DECIMALS = 2;
        function normalizeDecimal(s) {
            return s.replace(/[^\d,\.\-]/g, '').replace(',', '.');
        }
        function isValidDecimal(s) {
            return /^-?\d+(\.\d+)?$/.test(s);
        }
        function formatDecimal(s) {
            return Number(s).toFixed(DECIMALS);
        }

        function toNumberOrZero(val) {
            const num = Number(normalizeDecimal(String(val ?? '')));
            return isNaN(num) ? 0 : num;
        }

        // Evitar que contenteditable reciba HTML en pegado
        function stripPaste(e) {
            e.preventDefault();
      ");
                WriteLiteral(@"      const text = (e.clipboardData || window.clipboardData).getData('text');
            document.execCommand('insertText', false, text);
        }

        // Pegar “tipo Excel” (tab para columnas, \n para filas) repartiendo en celdas siguientes
        function handleGridPaste(e) {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text');
            const rows = text.split(/\r?\n/).filter(r => r.length);
            const start = e.target.closest('td');

            if (!start) return;

            let rowEl = start.parentElement;
            let cellIndex = Array.from(rowEl.children).indexOf(start);

            rows.forEach((rowStr, r) => {
                const cols = rowStr.split('\t');
                // Si no estamos en la primera fila pegada, mover a la siguiente <tr>
                if (r > 0) rowEl = rowEl.nextElementSibling;
                if (!rowEl) return;

                let cIndex = cellIndex;
               ");
                WriteLiteral(@" cols.forEach((val) => {
                    const cell = rowEl.children[cIndex];
                    if (!cell) return;
                    if (!cell.matches('td.dec')) { cIndex++; return; } // solo celdas dec
                    cell.innerText = val;
                    // Disparar validación inmediata
                    validateCell(cell);
                    actualizarValorPreview(cell.closest('tr'), cell.getAttribute('data-field'), val);
                    cIndex++;
                });
            });
        }

        function validateCell(td) {
            const v = normalizeDecimal(td.innerText.trim());
            if (v === '' || !isValidDecimal(v)) {
                td.classList.add('is-invalid');
            } else {
                td.classList.remove('is-invalid');
            }
        }

        // Bind a todas las celdas decimales
        document.querySelectorAll('#tablaMatriz td.dec').forEach(td => {
            td.addEventListener('paste', handleGridPaste); // Sop");
                WriteLiteral(@"orta pegado tipo Excel
            td.addEventListener('input', () => validateCell(td));
            td.addEventListener('blur', () => {
                let v = normalizeDecimal(td.innerText.trim());
                if (isValidDecimal(v)) td.innerText = formatDecimal(v);
                validateCell(td);
            });
        });

        function wireDecCells() {
            document.querySelectorAll('#tablaMatriz td.dec').forEach(td => {
                td.addEventListener('paste', handleGridPaste);
                td.addEventListener('input', () => validateCell(td));
                td.addEventListener('blur', () => {
                    let v = normalizeDecimal(td.innerText.trim());
                    if (isValidDecimal(v)) td.innerText = formatDecimal(v);
                    validateCell(td);
                });
            });
        }

        function renderEmptyRows(count = 10, tbodyEl) {
            const tbody = tbodyEl ?? document.querySelector('#tablaMatriz tbody');
   ");
                WriteLiteral(@"         if (!tbody) return;

            const placeholder = `
                    <tr class=""placeholder-row"">
                        <td>&nbsp;</td>
                        <td class=""sticky-col-start fw-semibold"">&nbsp;</td>
                        ${Array.from({ length: 19 }).map(() => '<td class=""placeholder-cell"">&nbsp;</td>').join('')}
                    </tr>`;

            tbody.innerHTML = Array.from({ length: count }).map(() => placeholder).join('');
        }

        // buscar y llenar tabla
        document.getElementById('btnBuscar')?.addEventListener('click', async () => {
            const periodo = document.getElementById('filtroPeriodo').value; // yyyy-mm
            const tiendas = checks().filter(ch => ch.checked).map(ch => ch.value).join(',');


            showLoading('Buscando información...');
            try {
                const url = `/Factores/Buscar?periodo=${encodeURIComponent(periodo)}&tiendas=${encodeURIComponent(tiendas)}`;
                const res ");
                WriteLiteral(@"= await fetch(url, { method: 'GET' });
                const data = await res.json();


                if (!res.ok) { showAlert(data.message || 'Error al buscar', 'danger'); updateDocEntryInfo(''); return; }

                const tbody = document.querySelector('#tablaMatriz tbody');
                if (Array.isArray(data) && data.length > 0) {
                    tbody.innerHTML = data.map(renderFila).join('');
                    wireDecCells();
                } else {
                    renderEmptyRows(10, tbody);
                }
                const docEntry = Array.isArray(data) && data.length ? (data[0].docEntry ?? data[0].DocEntry ?? '') : '';
                updateDocEntryInfo(docEntry);
                console.log('periodo ' + periodo);
                console.log('tiendas ' + tiendas);
                console.log('data ' + data.length);
                console.log('data JSON:', JSON.stringify(data, null, 2));

                const lbl = document.getElementById('lblResumen'");
                WriteLiteral(@");
                if (lbl) {
                    const total = Array.isArray(data) ? data.length : 0;
                    lbl.textContent = `Mostrando ${total} de ${total}`;
                }
            } catch (err) {
                console.error('ERROR FETCH:', err);
                showAlert('No se pudo conectar con el servidor.', 'danger');
                updateDocEntryInfo('');
            } finally {
                hideLoading();
            }
        });


        function renderFila(m) {
            console.log(`fila: ${m.u_MGS_CL_TIENDA} - ${m.u_MGS_CL_NOMTIE}`);

            return `
                    <tr data-id=""${m.lineId}"" data-lineid=""${m.lineId ?? ''}"" data-docentry=""${m.docEntry ?? ''}"" data-periodo=""${m.u_MGS_CL_PERIODO ?? ''}"" data-tienda=""${m.u_MGS_CL_TIENDA ?? ''}"" data-nomtien=""${m.u_MGS_CL_NOMTIE ?? ''}"">
            <td>${m.lineId ?? ''}</td> <!-- Codigo Interno / ProductoPlanner -->
            <td class=""sticky-col-start fw-semibold"">
                ${m.");
                WriteLiteral(@"u_MGS_CL_TIENDA ?? ''} - ${m.u_MGS_CL_NOMTIE ?? ''}
            </td>

            <td contenteditable=""true"" class=""dec"" data-field=""u_MGS_CL_META"">${m.u_MGS_CL_META ?? ''}</td>
            <td contenteditable=""true"" class=""dec"" data-field=""u_MGS_CL_RENTA"">${m.u_MGS_CL_RENTA ?? ''}</td>
            <td contenteditable=""true"" class=""dec"" data-field=""u_MGS_CL_VAN"">${m.u_MGS_CL_VAN ?? ''}</td>
            <td contenteditable=""true"" class=""dec"" data-field=""u_MGS_CL_ESTPER"">${m.u_MGS_CL_ESTPER ?? ''}</td>
            <td contenteditable=""true"" class=""dec"" data-field=""u_MGS_CL_GASADM"">${m.u_MGS_CL_GASADM ?? ''}</td>
            <td contenteditable=""true"" class=""dec"" data-field=""u_MGS_CL_COMTAR"">${m.u_MGS_CL_COMTAR ?? ''}</td>
            <td contenteditable=""true"" class=""dec"" data-field=""u_MGS_CL_IMPUES"">${m.u_MGS_CL_IMPUES ?? ''}</td>
            <td contenteditable=""true"" class=""dec"" data-field=""u_MGS_CL_REGALI"">${m.u_MGS_CL_REGALI ?? ''}</td>

            <td contenteditable=""true"" class=""dec"" data-");
                WriteLiteral(@"field=""u_MGS_CL_AUSER"">${m.u_MGS_CL_AUSER ?? ''}</td>
            <td contenteditable=""true"" class=""dec"" data-field=""u_MGS_CL_AUOPE"">${m.u_MGS_CL_AUOPE ?? ''}</td>
            <td contenteditable=""true"" class=""dec"" data-field=""u_MGS_CL_AUCCC"">${m.u_MGS_CL_AUCCC ?? ''}</td>
            <td contenteditable=""true"" class=""dec"" data-field=""u_MGS_CL_AUADH"">${m.u_MGS_CL_AUADH ?? ''}</td>
            <td contenteditable=""true"" class=""dec"" data-field=""u_MGS_CL_CLIMA"">${m.u_MGS_CL_CLIMA ?? ''}</td>
            <td contenteditable=""true"" class=""dec"" data-field=""u_MGS_CL_RUSTI"">${m.u_MGS_CL_RUSTI ?? ''}</td>
            <td contenteditable=""true"" class=""dec"" data-field=""u_MGS_CL_MELID"">${m.u_MGS_CL_MELID ?? ''}</td>
            <td contenteditable=""true"" class=""dec"" data-field=""u_MGS_CL_ADMGR"">${m.u_MGS_CL_ADMGR ?? ''}</td>
            <td contenteditable=""true"" class=""dec"" data-field=""u_MGS_CL_EXGES"">${m.u_MGS_CL_EXGES ?? ''}</td>
            <td contenteditable=""true"" class=""dec"" data-field=""u_MGS_CL_EXSER"">${");
                WriteLiteral(@"m.u_MGS_CL_EXSER ?? ''}</td>
            <td contenteditable=""true"" class=""dec"" data-field=""u_MGS_CL_EXMAR"">${m.u_MGS_CL_EXMAR ?? ''}</td>


</tr>`;
        }

        //<td class=""sticky-col-end text-center"">
        //    <button class=""btn btn-outline-secondary btn-xs me-1 btn-editar"" disabled>
        //        <i class=""bi bi-pencil-square""></i>
        //    </button>
        //    <button class=""btn btn-outline-danger btn-xs btn-eliminar"">
        //        <i class=""bi bi-trash""></i>
        //    </button>
        //</td>

        const nuevoEstado = document.getElementById('nuevoEstado');
        const nuevoDescripcion = document.getElementById('nuevoDescripcion');
        const tablaPreviewNuevoBody = document.querySelector('#tablaPreviewNuevo tbody');
        const nuevoPeriodoDestino = document.getElementById('nuevoPeriodoDestino');
        const nuevoFiltroTienda = document.getElementById('nuevoFiltroTienda');
        const btnFiltrarNuevo = document.getElementById('btnFiltr");
                WriteLiteral(@"arNuevo');
        const btnLimpiarFiltroNuevo = document.getElementById('btnLimpiarFiltroNuevo');

        function setNuevoEstado(msg, type = 'info') {
            if (!nuevoEstado) return;
            nuevoEstado.textContent = msg;
            nuevoEstado.className = `alert alert-${type}`;
            nuevoEstado.classList.remove('d-none');
        }

        function clearNuevoEstado() {
            if (!nuevoEstado) return;
            nuevoEstado.classList.add('d-none');
            nuevoEstado.textContent = '';
        }

        function obtenerNombreTienda(codigo) {
            const found = tiendasCache.find(t => (t.codigo ?? t.Codigo ?? '').trim() === codigo);
            return found ? (found.nombre ?? found.Nombre ?? '') : '';
        }

        function armarPreview(data) {
            previewData = (data || []).map(previo => {
                const tienda = (previo.u_MGS_CL_TIENDA ?? previo.U_MGS_CL_TIENDA ?? '').trim();
                const nombre = previo.u_MGS_CL_NOM");
                WriteLiteral(@"TIE ?? previo.U_MGS_CL_NOMTIE ?? obtenerNombreTienda(tienda);
                const periodoBase = previo.u_MGS_CL_PERIODO ?? previo.U_MGS_CL_PERIODO ?? '';
                const periodoDestino = previo.u_MGS_CL_PERIODO_DEST ?? previo.U_MGS_CL_PERIODO_DEST ?? '';

                if (!nuevoPeriodoDestinoValor && periodoDestino) {
                    nuevoPeriodoDestinoValor = periodoDestino;
                    if (nuevoPeriodoDestino) nuevoPeriodoDestino.value = periodoDestino;
                }

                return {
                    U_MGS_CL_PERIODO: periodoBase,
                    U_MGS_CL_PERIODO_DEST: periodoDestino,
                    U_MGS_CL_TIENDA: tienda,
                    U_MGS_CL_NOMTIE: nombre,
                    LineId: previo.lineId ?? previo.LineId ?? '',
                    U_MGS_CL_META: toNumberOrZero(previo.u_MGS_CL_META ?? previo.U_MGS_CL_META),
                    U_MGS_CL_RENTA: toNumberOrZero(previo.u_MGS_CL_RENTA ?? previo.U_MGS_CL_RENTA),
                 ");
                WriteLiteral(@"   U_MGS_CL_VAN: toNumberOrZero(previo.u_MGS_CL_VAN ?? previo.U_MGS_CL_VAN),
                    U_MGS_CL_ESTPER: toNumberOrZero(previo.u_MGS_CL_ESTPER ?? previo.U_MGS_CL_ESTPER),
                    U_MGS_CL_GASADM: toNumberOrZero(previo.u_MGS_CL_GASADM ?? previo.U_MGS_CL_GASADM),
                    U_MGS_CL_COMTAR: toNumberOrZero(previo.u_MGS_CL_COMTAR ?? previo.U_MGS_CL_COMTAR),
                    U_MGS_CL_IMPUES: toNumberOrZero(previo.u_MGS_CL_IMPUES ?? previo.U_MGS_CL_IMPUES),
                    U_MGS_CL_REGALI: toNumberOrZero(previo.u_MGS_CL_REGALI ?? previo.U_MGS_CL_REGALI),
                    U_MGS_CL_AUSER: toNumberOrZero(previo.u_MGS_CL_AUSER ?? previo.U_MGS_CL_AUSER),
                    U_MGS_CL_AUOPE: toNumberOrZero(previo.u_MGS_CL_AUOPE ?? previo.U_MGS_CL_AUOPE),
                    U_MGS_CL_AUCCC: toNumberOrZero(previo.u_MGS_CL_AUCCC ?? previo.U_MGS_CL_AUCCC),
                    U_MGS_CL_AUADH: toNumberOrZero(previo.u_MGS_CL_AUADH ?? previo.U_MGS_CL_AUADH),
                    U_");
                WriteLiteral(@"MGS_CL_CLIMA: toNumberOrZero(previo.u_MGS_CL_CLIMA ?? previo.U_MGS_CL_CLIMA),
                    U_MGS_CL_RUSTI: toNumberOrZero(previo.u_MGS_CL_RUSTI ?? previo.U_MGS_CL_RUSTI),
                    U_MGS_CL_MELID: toNumberOrZero(previo.u_MGS_CL_MELID ?? previo.U_MGS_CL_MELID),
                    U_MGS_CL_ADMGR: toNumberOrZero(previo.u_MGS_CL_ADMGR ?? previo.U_MGS_CL_ADMGR),
                    U_MGS_CL_EXGES: toNumberOrZero(previo.u_MGS_CL_EXGES ?? previo.U_MGS_CL_EXGES),
                    U_MGS_CL_EXSER: toNumberOrZero(previo.u_MGS_CL_EXSER ?? previo.U_MGS_CL_EXSER),
                    U_MGS_CL_EXMAR: toNumberOrZero(previo.u_MGS_CL_EXMAR ?? previo.U_MGS_CL_EXMAR),
                    U_MGS_CL_PRIMARY: previo.u_MGS_CL_PRIMARY ?? previo.U_MGS_CL_PRIMARY ?? ''
                };
            });
        }

        function renderPreviewTabla(dataParaMostrar) {
            if (!tablaPreviewNuevoBody) return;
            const filas = Array.isArray(dataParaMostrar) ? dataParaMostrar : previewData");
                WriteLiteral(@";

            if (!filas.length) {
                tablaPreviewNuevoBody.innerHTML = '<tr><td colspan=""21"" class=""text-center text-muted"">Sin información para mostrar.</td></tr>';
                return;
            }

            tablaPreviewNuevoBody.innerHTML = filas.map(item => `
                    <tr data-tienda=""${item.U_MGS_CL_TIENDA ?? ''}"">
                        <td class=""fw-semibold"">${item.LineId ?? ''}</td>
                        <td class=""sticky-col-start fw-semibold"">${item.U_MGS_CL_TIENDA ?? ''} - ${item.U_MGS_CL_NOMTIE ?? ''}</td>
                        <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_META"">${formatDecimal(String(item.U_MGS_CL_META ?? '0'))}</td>
                        <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_RENTA"">${formatDecimal(String(item.U_MGS_CL_RENTA ?? '0'))}</td>
                        <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_VAN"">${formatDecimal(String(item.U_MGS_CL_VAN ?? '0'))}</td>
        ");
                WriteLiteral(@"                <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_ESTPER"">${formatDecimal(String(item.U_MGS_CL_ESTPER ?? '0'))}</td>
                        <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_GASADM"">${formatDecimal(String(item.U_MGS_CL_GASADM ?? '0'))}</td>
                        <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_COMTAR"">${formatDecimal(String(item.U_MGS_CL_COMTAR ?? '0'))}</td>
                        <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_IMPUES"">${formatDecimal(String(item.U_MGS_CL_IMPUES ?? '0'))}</td>
                        <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_REGALI"">${formatDecimal(String(item.U_MGS_CL_REGALI ?? '0'))}</td>
                        <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_AUSER"">${formatDecimal(String(item.U_MGS_CL_AUSER ?? '0'))}</td>
                        <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_AUOPE"">${formatDecimal(String(item.U_M");
                WriteLiteral(@"GS_CL_AUOPE ?? '0'))}</td>
                        <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_AUCCC"">${formatDecimal(String(item.U_MGS_CL_AUCCC ?? '0'))}</td>
                        <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_AUADH"">${formatDecimal(String(item.U_MGS_CL_AUADH ?? '0'))}</td>
                        <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_CLIMA"">${formatDecimal(String(item.U_MGS_CL_CLIMA ?? '0'))}</td>
                        <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_RUSTI"">${formatDecimal(String(item.U_MGS_CL_RUSTI ?? '0'))}</td>
                        <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_MELID"">${formatDecimal(String(item.U_MGS_CL_MELID ?? '0'))}</td>
                        <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_ADMGR"">${formatDecimal(String(item.U_MGS_CL_ADMGR ?? '0'))}</td>
                        <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_EXGES"">${for");
                WriteLiteral(@"matDecimal(String(item.U_MGS_CL_EXGES ?? '0'))}</td>
                        <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_EXSER"">${formatDecimal(String(item.U_MGS_CL_EXSER ?? '0'))}</td>
                        <td contenteditable=""true"" class=""dec"" data-field=""U_MGS_CL_EXMAR"">${formatDecimal(String(item.U_MGS_CL_EXMAR ?? '0'))}</td>
                    </tr>
                `).join('');

            wirePreviewDecCells();
        }

        function actualizarValorPreview(tr, field, rawVal) {
            const tienda = tr?.dataset.tienda;
            if (!tienda || !field) return;
            const fila = previewData.find(p => (p.U_MGS_CL_TIENDA ?? '').trim() === tienda.trim());
            if (!fila) return;
            fila[field] = toNumberOrZero(rawVal);
        }

        function wirePreviewDecCells() {
            document.querySelectorAll('#tablaPreviewNuevo td.dec').forEach(td => {
                td.addEventListener('paste', handleGridPaste);
                td.ad");
                WriteLiteral(@"dEventListener('input', () => {
                    validateCell(td);
                    actualizarValorPreview(td.closest('tr'), td.getAttribute('data-field'), td.innerText);
                });
                td.addEventListener('blur', () => {
                    let v = normalizeDecimal(td.innerText.trim());
                    if (isValidDecimal(v)) td.innerText = formatDecimal(v);
                    validateCell(td);
                    actualizarValorPreview(td.closest('tr'), td.getAttribute('data-field'), v);
                });
            });
        }

        function aplicarFiltroPreview() {
            const term = (nuevoFiltroTienda?.value ?? '').toLowerCase().trim();
            if (!term) {
                renderPreviewTabla(previewData);
                return;
            }

            const filtrado = previewData.filter(p => {
                const texto = `${p.U_MGS_CL_TIENDA ?? ''} ${p.U_MGS_CL_NOMTIE ?? ''}`.toLowerCase();
                return texto.includes(");
                WriteLiteral(@"term);
            });

            renderPreviewTabla(filtrado);
        }

        async function abrirModalNuevo() {
            clearAlert();
            //const tiendasSeleccionadas = checks().filter(ch => ch.checked).map(ch => ch.value);

            nuevoPeriodoDestinoValor = '';
            if (nuevoPeriodoDestino) nuevoPeriodoDestino.value = '';
            //if (nuevoFiltroTienda) nuevoFiltroTienda.value = tiendasSeleccionadas.join(',');

            if (nuevoDescripcion) {
                nuevoDescripcion.textContent = 'Se copiarán los valores del último periodo registrado hacia el siguiente periodo disponible.';
            }

            setNuevoEstado('Consultando información del último periodo...', 'info');
            if (tablaPreviewNuevoBody) tablaPreviewNuevoBody.innerHTML = '';
            showLoading('Consultando información del último periodo...');

            // Construir URL de consulta antes de invocar fetch para evitar referencias indefinidas
            //con");
                WriteLiteral(@"st urlPrevisualizar = `/Factores/Previsualizar?tiendas=${encodeURIComponent(tiendasSeleccionadas.join(','))}`;
            const urlPrevisualizar = `/Factores/Previsualizar`;

            try {
                const res = await fetch(urlPrevisualizar);
                let data = [];

                try {
                    const raw = await res.text();
                    data = raw ? JSON.parse(raw) : [];
                } catch (parseErr) {
                    console.error('ERROR PREVIA NUEVO: parse JSON', parseErr);
                }

                if (!res.ok) {
                    const msg = (data && data.message) ? data.message : `No se pudo obtener la información (HTTP ${res.status}).`;
                    setNuevoEstado(msg, 'danger');
                    return;
                }

                armarPreview(Array.isArray(data) ? data : []);
                if (previewData.length) {
                    const periodoOrigen = previewData[0]?.U_MGS_CL_PERIODO ?? '';
       ");
                WriteLiteral(@"             if (nuevoPeriodoDestinoValor && nuevoDescripcion) {
                        nuevoDescripcion.textContent = `Se copiarán los valores del periodo ${periodoOrigen} hacia ${nuevoPeriodoDestinoValor}.`;
                    }
                    if (nuevoPeriodoDestino && nuevoPeriodoDestinoValor) {
                        nuevoPeriodoDestino.value = nuevoPeriodoDestinoValor;
                    }
                }

                aplicarFiltroPreview();
                clearNuevoEstado();

                modalNuevo = modalNuevo ?? new bootstrap.Modal(document.getElementById('modalNuevo'));
                modalNuevo.show();
            } catch (err) {
                console.error('ERROR PREVIA NUEVO:', err);
                setNuevoEstado('No se pudo conectar con el servidor.', 'danger');
            } finally {
                hideLoading();
            }
        }

        async function crearMatrizDesdeModal() {
            if (!previewData.length) {
                setNue");
                WriteLiteral(@"voEstado('No hay información para registrar.', 'warning');
                return;
            }

            const periodoDestino = nuevoPeriodoDestinoValor || (previewData[0]?.U_MGS_CL_PERIODO_DEST ?? '');
            if (!periodoDestino) {
                setNuevoEstado('No se pudo determinar el periodo destino.', 'danger');
                return;
            }
            const payload = {
                U_MGS_CL_PERIODO: `${periodoDestino}-01`,
                MGS_CL_FACDETCollection: previewData.map(p => ({
                    U_MGS_CL_TIENDA: p.U_MGS_CL_TIENDA,
                    U_MGS_CL_NOMTIE: p.U_MGS_CL_NOMTIE ?? '',
                    U_MGS_CL_META: toNumberOrZero(p.U_MGS_CL_META),
                    U_MGS_CL_RENTA: toNumberOrZero(p.U_MGS_CL_RENTA),
                    U_MGS_CL_VAN: toNumberOrZero(p.U_MGS_CL_VAN),
                    U_MGS_CL_ESTPER: toNumberOrZero(p.U_MGS_CL_ESTPER),
                    U_MGS_CL_GASADM: toNumberOrZero(p.U_MGS_CL_GASADM),
                  ");
                WriteLiteral(@"  U_MGS_CL_COMTAR: toNumberOrZero(p.U_MGS_CL_COMTAR),
                    U_MGS_CL_IMPUES: toNumberOrZero(p.U_MGS_CL_IMPUES),
                    U_MGS_CL_REGALI: toNumberOrZero(p.U_MGS_CL_REGALI),
                    U_MGS_CL_AUSER: toNumberOrZero(p.U_MGS_CL_AUSER),
                    U_MGS_CL_AUOPE: toNumberOrZero(p.U_MGS_CL_AUOPE),
                    U_MGS_CL_AUCCC: toNumberOrZero(p.U_MGS_CL_AUCCC),
                    U_MGS_CL_AUADH: toNumberOrZero(p.U_MGS_CL_AUADH),
                    U_MGS_CL_CLIMA: toNumberOrZero(p.U_MGS_CL_CLIMA),
                    U_MGS_CL_RUSTI: toNumberOrZero(p.U_MGS_CL_RUSTI),
                    U_MGS_CL_MELID: toNumberOrZero(p.U_MGS_CL_MELID),
                    U_MGS_CL_ADMGR: toNumberOrZero(p.U_MGS_CL_ADMGR),
                    U_MGS_CL_EXGES: toNumberOrZero(p.U_MGS_CL_EXGES),
                    U_MGS_CL_EXSER: toNumberOrZero(p.U_MGS_CL_EXSER),
                    U_MGS_CL_EXMAR: toNumberOrZero(p.U_MGS_CL_EXMAR),
                    U_MGS_CL_PRIMARY: p.U_");
                WriteLiteral(@"MGS_CL_PRIMARY ?? ''
                }))
            };

            try {
                setNuevoEstado('Guardando información...', 'info');
                showLoading('Guardando información...');
                const res = await fetch('/Factores/Crear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (!res.ok || !data.registered) {
                    setNuevoEstado(data.message || 'No se pudo crear la matriz.', 'danger');
                    return;
                }

                clearNuevoEstado();
                modalNuevo?.hide();
                showAlert(data.message || 'Información cargada correctamente.', 'success');
                document.getElementById('btnBuscar')?.click();
            } catch (err) {
                console.error('ERROR CREAR:', err);
                s");
                WriteLiteral(@"etNuevoEstado('No se pudo crear la matriz.', 'danger');
            } finally {
                hideLoading();
            }
        }

        document.getElementById('btnNuevo')?.addEventListener('click', abrirModalNuevo);
        document.getElementById('btnConfirmarNuevo')?.addEventListener('click', crearMatrizDesdeModal);
        btnFiltrarNuevo?.addEventListener('click', (e) => { e.preventDefault(); aplicarFiltroPreview(); });
        btnLimpiarFiltroNuevo?.addEventListener('click', (e) => { e.preventDefault(); if (nuevoFiltroTienda) nuevoFiltroTienda.value = ''; aplicarFiltroPreview(); });
        nuevoFiltroTienda?.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); aplicarFiltroPreview(); } });
        document.getElementById('btnPeriodoAnterior')?.addEventListener('click', () => cambiarPeriodo(-1));
        document.getElementById('btnPeriodoSiguiente')?.addEventListener('click', () => cambiarPeriodo(1));

        const FIELD_MAP = {
            'u_MGS_CL");
                WriteLiteral(@"_META': 'U_MGS_CL_META',
            'u_MGS_CL_RENTA': 'U_MGS_CL_RENTA',
            'u_MGS_CL_VAN': 'U_MGS_CL_VAN',
            'u_MGS_CL_ESTPER': 'U_MGS_CL_ESTPER',
            'u_MGS_CL_GASADM': 'U_MGS_CL_GASADM',
            'u_MGS_CL_COMTAR': 'U_MGS_CL_COMTAR',
            'u_MGS_CL_IMPUES': 'U_MGS_CL_IMPUES',
            'u_MGS_CL_REGALI': 'U_MGS_CL_REGALI',
            'u_MGS_CL_AUSER': 'U_MGS_CL_AUSER',
            'u_MGS_CL_AUOPE': 'U_MGS_CL_AUOPE',
            'u_MGS_CL_AUCCC': 'U_MGS_CL_AUCCC',
            'u_MGS_CL_AUADH': 'U_MGS_CL_AUADH',
            'u_MGS_CL_CLIMA': 'U_MGS_CL_CLIMA',
            'u_MGS_CL_RUSTI': 'U_MGS_CL_RUSTI',
            'u_MGS_CL_MELID': 'U_MGS_CL_MELID',
            'u_MGS_CL_ADMGR': 'U_MGS_CL_ADMGR',
            'u_MGS_CL_EXGES': 'U_MGS_CL_EXGES',
            'u_MGS_CL_EXSER': 'U_MGS_CL_EXSER',
            'u_MGS_CL_EXMAR': 'U_MGS_CL_EXMAR',
        };
        // ---------- Actualizar todo ----------


        document.getElementById('btnActualiz");
                WriteLiteral(@"arTodo')?.addEventListener('click', async () => {
            // Recolectar filas
            const rows = Array.from(document.querySelectorAll('#tablaMatriz tbody tr'));
            if (!rows.length) {
                showAlert('No hay información para actualizar.', 'warning');
                return;
            }

            // Validar que no haya celdas con error
            const invalids = document.querySelectorAll('#tablaMatriz td.dec.is-invalid');
            if (invalids.length) {
                showAlert('Corrige los valores inválidos antes de actualizar.', 'warning');
                invalids[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }

            const docEntry = rows[0].dataset.docentry;
            if (!docEntry) {
                showAlert('No se encontró el DocEntry de la matriz.', 'danger');
                return;
            }

            const payload = {
                MGS_CL_FACDETCollection: rows.map(tr =>");
                WriteLiteral(@" {
                    const detalle = {
                        LineId: tr.dataset.lineid || '',
                        U_MGS_CL_PRIMARY: ''
                    };

                    tr.querySelectorAll('td.dec').forEach(td => {
                        const key = td.getAttribute('data-field');
                        const val = normalizeDecimal(td.innerText.trim());
                        const mappedKey = key ? FIELD_MAP[key] : '';
                        if (!mappedKey) return;
                        detalle[mappedKey] = val === '' ? 0 : Number(val);
                    });

                    return detalle;
                })
            };

            try {
                showLoading('Actualizando matriz...');
                const res = await fetch(`/Factores/Actualizar?docEntry=${encodeURIComponent(docEntry)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
  ");
                WriteLiteral(@"              }); const data = await res.json();
                if (!res.ok || !data.registered) {
                    showAlert(data.message || 'Error al actualizar', 'danger');
                    return;
                }

                showAlert(data.message || 'Actualizado correctamente', 'success');
            } catch (err) {
                console.error('ERROR ACTUALIZAR:', err);
                showAlert('No se pudo actualizar la matriz.', 'danger');
            } finally {
                hideLoading();
            }
        });

        // Eliminar fila (demo)
        document.querySelectorAll('.btn-eliminar').forEach(btn => {
            btn.addEventListener('click', () => {
                const tr = btn.closest('tr');
                tr?.remove();
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            renderEmptyRows();
            cargarTiendas();
            updateDocEntryInfo('');
            if (window.bootstrap &");
                WriteLiteral("& document.getElementById(\'modalNuevo\')) {\r\n                modalNuevo = new bootstrap.Modal(document.getElementById(\'modalNuevo\'));\r\n            }\r\n        });\r\n    </script>\r\n");
            }
            );
        }
        #pragma warning restore 1998
        [global::Microsoft.AspNetCore.Mvc.Razor.Internal.RazorInjectAttribute]
        public global::Microsoft.AspNetCore.Mvc.ViewFeatures.IModelExpressionProvider ModelExpressionProvider { get; private set; }
        [global::Microsoft.AspNetCore.Mvc.Razor.Internal.RazorInjectAttribute]
        public global::Microsoft.AspNetCore.Mvc.IUrlHelper Url { get; private set; }
        [global::Microsoft.AspNetCore.Mvc.Razor.Internal.RazorInjectAttribute]
        public global::Microsoft.AspNetCore.Mvc.IViewComponentHelper Component { get; private set; }
        [global::Microsoft.AspNetCore.Mvc.Razor.Internal.RazorInjectAttribute]
        public global::Microsoft.AspNetCore.Mvc.Rendering.IJsonHelper Json { get; private set; }
        [global::Microsoft.AspNetCore.Mvc.Razor.Internal.RazorInjectAttribute]
        public global::Microsoft.AspNetCore.Mvc.Rendering.IHtmlHelper<RusticaPortal_PRMVAN.Web.Models.MatrizFactoresViewModel> Html { get; private set; }
    }
}
#pragma warning restore 1591
